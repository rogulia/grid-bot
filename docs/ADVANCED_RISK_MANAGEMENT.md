# –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏ —Å Initial Margin

**–î–∞—Ç–∞:** 13 –æ–∫—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è:** 3.0 (–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–µ–∑–µ—Ä–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –≤ –º–æ–Ω–µ—Ç–∞—Ö)
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏

**üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í V3.0:**
- ‚úÖ –†–µ–∑–µ—Ä–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ **–ú–û–ù–ï–¢** (SOL, DOGE, TON), –Ω–µ —É—Ä–æ–≤–Ω–µ–π grid
- ‚úÖ –†–µ–∑–µ—Ä–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ **–ê–ö–ö–ê–£–ù–¢–ê** (—Å—É–º–º–∏—Ä—É–µ—Ç –í–°–ï —Ç–æ—Ä–≥—É–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã)
- ‚úÖ –†–µ–∑–µ—Ä–≤ **–î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô** (–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–π/—Ü–µ–Ω—ã)
- ‚úÖ –†–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏ –±–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç **–í–°–ï —Å–∏–º–≤–æ–ª—ã** –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚ùå –£–î–ê–õ–Å–ù —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑–µ—Ä–≤ (worst-case –¥–ª—è max_grid_levels) - –±–æ–º–±–∞ –∑–∞–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è!

## üöÄ –ö–ª—é—á–µ–≤–æ–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: WebSocket-First

**–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–ª—É—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Wallet WebSocket, –ù–ï —á–µ—Ä–µ–∑ REST API!**

```
Wallet WebSocket (real-time) ‚Üí BalanceManager (cache) ‚Üí Strategy (instant access)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **Real-time –¥–∞–Ω–Ω—ã–µ**: –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫ REST API)
- ‚úÖ **–ù—É–ª–µ–≤—ã–µ REST API –≤—ã–∑–æ–≤—ã**: –ü–æ—Å–ª–µ startup –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ WebSocket
- ‚úÖ **Thread-safe –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: BalanceManager –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –ö–∞–∫ Position/Order/Wallet - –≤—Å–µ —á–µ—Ä–µ–∑ WebSocket

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ Wallet WebSocket:**
- `totalAvailableBalance` - –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –∞–∫–∫–∞—É–Ω—Ç–∞
- `totalInitialMargin` - –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π IM –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
- `totalMaintenanceMargin` - —Ç—Ä–µ–±—É–µ–º—ã–π MM –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏
- `accountMMRate` - Account Maintenance Margin Rate (%)

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
# –ù–ï –¢–ê–ö (—Å—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥ —Å REST API):
# balance = bybit_client.get_wallet_balance()['result']['list'][0]['totalAvailableBalance']

# –¢–ê–ö (WebSocket-first):
balance = balance_manager.get_available_balance()  # –ò–∑ WebSocket –∫–µ—à–∞
initial_margin = balance_manager.get_initial_margin()  # Real-time!
```

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏](#1-–∫–ª—é—á–µ–≤—ã–µ-–∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
2. [–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Å–ª–µ TP](#2-–∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ-–ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ-–ø–æ—Å–ª–µ-tp)
3. [Initial Margin —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ](#3-initial-margin-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
4. [–†–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)](#4-—Ä–µ–∂–∏–º-–ø–∞–Ω–∏–∫–∏-–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)
5. [–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã](#5-–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ-–ø—Ä–∏–º–µ—Ä—ã)
6. [–ü—Å–µ–≤–¥–æ–∫–æ–¥ –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#6-–ø—Å–µ–≤–¥–æ–∫–æ–¥-–ø–æ–ª–Ω–æ–π-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
7. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#7-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)

---

## 1. –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### 1.1 –ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç MM Rate –∫ Initial Margin

**–°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥ (–ø—Ä–æ–±–ª–µ–º–Ω—ã–π):**
```
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: Account MM Rate (Maintenance Margin)
–ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–ø–∞–∑–¥—ã–≤–∞—é—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä - —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –∫–æ–≥–¥–∞ —É–∂–µ –ø–æ–∑–¥–Ω–æ
–†–µ–∑—É–ª—å—Ç–∞—Ç: –õ–∏–∫–≤–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∑–∞—â–∏—Ç—ã
```

**–ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):**
```
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: Available Initial Margin
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π –î–û –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞
```

### 1.2 –ú–µ—Ç—Ä–∏–∫–∏ –æ—Ç Bybit (—á–µ—Ä–µ–∑ Wallet WebSocket)

```python
# –î–∞–Ω–Ω—ã–µ –∏–∑ Wallet WebSocket (–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)
# –ö–µ—à–∏—Ä—É—é—Ç—Å—è –≤ BalanceManager –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ REST API –≤—ã–∑–æ–≤–æ–≤
total_balance = balance_manager.get_available_balance()         # $6,000 (totalAvailableBalance)
used_IM = balance_manager.get_initial_margin()                  # $4,000 (totalInitialMargin)
used_MM = balance_manager.get_maintenance_margin()              # $1,500 (totalMaintenanceMargin)
account_mm_rate = balance_manager.get_mm_rate()                 # 0.15% (accountMMRate as %)

# –ö–ª—é—á–µ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã
safety_reserve = calculate_safety_reserve()                     # –†–∞—Å—á–µ—Ç –Ω–∏–∂–µ
available_for_trading = total_balance - safety_reserve          # totalAvailableBalance –£–ñ–ï –≤—ã—á–µ–ª IM!

# –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Wallet WebSocket:
# - Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫ REST API)
# - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ BalanceManager (thread-safe)
# - –ù–µ—Ç REST API –≤—ã–∑–æ–≤–æ–≤ –ø–æ—Å–ª–µ startup
```

### 1.3 Portfolio Margin Fields Reference (Unified Account)

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø–æ–ª–µ–π Bybit –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã—á–∏—Ç–∞–Ω–∏—è IM!**

**–ü–æ–ª—è –∏–∑ Wallet WebSocket:**

| –ü–æ–ª–µ Bybit | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è |
|------------|----------|-----------------|
| `totalEquity` | –û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª = cash + unrealized PnL | $10,000 |
| `totalAvailableBalance` | **–£–ñ–ï –≤—ã—á—Ç–µ–Ω—ã** positionIM + orderIM | $6,000 |
| `totalInitialMargin` | IM –∑–∞–Ω—è—Ç—ã–π –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏ | $3,500 |
| `totalOrderIM` | IM –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ –æ—Ä–¥–µ—Ä–∞ | $500 |
| `totalMaintenanceMargin` | MM –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ | $1,500 |
| `accountMMRate` | (totalMaintenanceMargin / totalEquity) √ó 100 | 15% |

**–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø–æ–ª–µ–π:**

```python
# Bybit —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–∞–∫:
totalEquity = cash + unrealized_pnl                                    # $10,000
totalAvailableBalance = totalEquity - totalInitialMargin - totalOrderIM  # $10,000 - $3,500 - $500 = $6,000

# ‚ö†Ô∏è totalAvailableBalance –£–ñ–ï –í–´–ß–ï–õ IM!
```

**‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê–Ø —Ñ–æ—Ä–º—É–ª–∞ (–¥–≤–æ–π–Ω–æ–µ –≤—ã—á–∏—Ç–∞–Ω–∏–µ):**

```python
# –û–®–ò–ë–ö–ê: –í—ã—á–∏—Ç–∞–µ–º IM –≤—Ç–æ—Ä–æ–π —Ä–∞–∑!
available_for_trading_WRONG = totalAvailableBalance - totalInitialMargin - safety_reserve
# $6,000 - $3,500 - $500 = $2,000 ‚ùå

# –ò–ª–∏ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ:
available_for_trading_WRONG = totalEquity - totalInitialMargin - totalOrderIM - totalInitialMargin - safety_reserve
#                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
#                              –≠—Ç–æ totalAvailableBalance!
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø —Ñ–æ—Ä–º—É–ª–∞ (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è –¥–ª—è –±–æ—Ç–∞):**

```python
# –î–∞–Ω–Ω—ã–µ –∏–∑ WebSocket (—á–µ—Ä–µ–∑ BalanceManager)
total_available_balance = balance_manager.get_available_balance()  # $6,000 (totalAvailableBalance)
total_initial_margin = balance_manager.get_initial_margin()        # $3,500 (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
total_order_im = 0  # –û–±—ã—á–Ω–æ 0 (–∏—Å–ø–æ–ª—å–∑—É–µ–º market –æ—Ä–¥–µ—Ä–∞, –æ–Ω–∏ –Ω–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä—É—é—Ç IM)

# –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏!)
safety_reserve = calculate_account_safety_reserve()  # $500 (–Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏—Å–±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ–∑–∏—Ü–∏–π)

# –ö–ê–ù–û–ù–ò–ß–ï–°–ö–ê–Ø —Ñ–æ—Ä–º—É–ª–∞
available_for_trading = total_available_balance - safety_reserve
# $6,000 - $500 = $5,500 ‚úÖ

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º
if available_for_trading >= next_margin:
    execute_averaging()  # –ë–µ–∑–æ–ø–∞—Å–Ω–æ
else:
    block_averaging()    # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
```

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–æ–≤:**

```python
# –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ (–∏–∑ Wallet WebSocket):
totalEquity = $10,000
totalInitialMargin = $3,500  # –ü–æ–∑–∏—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç $3,500 IM
totalOrderIM = $500          # Pending –æ—Ä–¥–µ—Ä–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä—É—é—Ç $500 IM
totalAvailableBalance = $10,000 - $3,500 - $500 = $6,000

# –†–∞—Å—á–µ—Ç safety_reserve (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π):
# DOGEUSDT: 400 DOGE imbalance √ó $0.15 = $60
# TONUSDT: 40 TON imbalance √ó $5.00 = $200
# Total: ($60 + $200) √ó 1.20 (safety factor) = $312

safety_reserve = $312

# –§–∏–Ω–∞–ª—å–Ω—ã–π available –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π:
available_for_trading = $6,000 - $312 = $5,688 ‚úÖ

# ‚ùå –ï—Å–ª–∏ –±—ã –≤—ã—á–ª–∏ IM –≤—Ç–æ—Ä–æ–π —Ä–∞–∑:
# available_WRONG = $6,000 - $3,500 - $312 = $2,188
# –ü–æ—Ç–µ—Ä—è–ª–∏ –±—ã $3,500 –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤!
```

**–í—ã–≤–æ–¥:**
- ‚úÖ `totalAvailableBalance` –£–ñ–ï –≤—ã—á–µ–ª –≤—Å–µ IM (position + order)
- ‚úÖ –í—ã—á–∏—Ç–∞–µ–º –∏–∑ –Ω–µ–≥–æ –¢–û–õ–¨–ö–û `safety_reserve`
- ‚ùå –ù–ï –≤—ã—á–∏—Ç–∞–µ–º `totalInitialMargin` –≤—Ç–æ—Ä–æ–π —Ä–∞–∑!
- ‚úÖ `totalInitialMargin` –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞/–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### 1.4 –ñ–µ–ª–µ–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

```
–ü–†–ê–í–ò–õ–û 1: –†–µ–∑–µ—Ä–≤ –Ω–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–µ–Ω
- safety_reserve –í–°–ï–ì–î–ê –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü–µ—Ä–µ–¥ –ö–ê–ñ–î–´–ú —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–∞
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π –î–û –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞

–ü–†–ê–í–ò–õ–û 2: –î–∏—Å–±–∞–ª–∞–Ω—Å ‚â† –ø–∞–Ω–∏–∫–∞
- –î–∏—Å–±–∞–ª–∞–Ω—Å –ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º IM ‚Üí –ø—Ä–æ—Å—Ç–æ –∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π —Ö–µ–¥–∂
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç
- –ü–∞–Ω–∏–∫–∞ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ IM –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω

–ü–†–ê–í–ò–õ–û 3: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –≤ —É–±—ã—Ç–æ–∫
- –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Å—Ä–µ–¥—Å—Ç–≤ ‚Üí –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
- –ñ–¥–∞—Ç—å —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Ä—ã–Ω–∫–∞
- –ó–∞–∫—Ä—ã—Ç–∏–µ —Ç–æ–ª—å–∫–æ —Å –ø—Ä–æ—Ñ–∏—Ç–æ–º

–ü–†–ê–í–ò–õ–û 4: –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ
- –ö–æ–º–∏—Å—Å–∏–∏ ‚Üí –∏–∑ Bybit API
- Funding rates ‚Üí –∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å ‚Üí –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ù–∏–∫–∞–∫–∏—Ö hardcoded –∑–Ω–∞—á–µ–Ω–∏–π!

–ü–†–ê–í–ò–õ–û 5: 100% –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
- –ë–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- –í—Å–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

---

## 2. –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Å–ª–µ TP

### 2.1 –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏:**
```
–ü–æ—Å–ª–µ TP –ø–æ–∑–∏—Ü–∏—è –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å –Ω–∞—á–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º ($1 –º–∞—Ä–∂–∞)
‚Üí –î–∏—Å–±–∞–ª–∞–Ω—Å –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å—á–µ–∑–∞–µ—Ç
‚Üí –ê—Å–∏–º–º–µ—Ç—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞

–ü—Ä–∏–º–µ—Ä:
SHORT —É—Ä–æ–≤–µ–Ω—å 5: $2,325 –ø–æ–∑–∏—Ü–∏—è
LONG –∑–∞–∫—Ä—ã–ª—Å—è –ø–æ TP ‚Üí –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å $75
–î–∏—Å–±–∞–ª–∞–Ω—Å: 31:1 (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è!)
```

**–†–µ—à–µ–Ω–∏–µ - –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ:**
```
–†–∞–∑–º–µ—Ä –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞:
- –ë–æ–ª—å—à–æ–π –¥–∏—Å–±–∞–ª–∞–Ω—Å ‚Üí –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å—Å—è —Å 100% —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π
- –°—Ä–µ–¥–Ω–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å ‚Üí –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å—Å—è —Å 25-50% —Ä–∞–∑–º–µ—Ä–∞
- –ú–∞–ª—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å ‚Üí –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å—Å—è —Å –Ω–∞—á–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏–º–º–µ—Ç—Ä–∏–∏
```

### 2.2 –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è

#### –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞

**–ü—Ä–æ–±–ª–µ–º–∞ —Å—Ç–∞—Ä–æ–π —Ñ–æ—Ä–º—É–ª—ã (–ø–æ level_diff):**
- –£—Ä–æ–≤–Ω–∏ ‚â† –Ω–æ—Ç–∏–æ–Ω–∞–ª –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —Ü–µ–Ω–∞—Ö
- Level 5 @ $0.10 ‚â† Level 5 @ $0.15 (—Ä–∞–∑–Ω–∞—è –º–∞—Ä–∂–∞!)

**–ù–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ (–ø–æ margin_ratio):**

```python
def calculate_reopen_size(closed_side, opposite_side):
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ MARGIN –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞

    Args:
        closed_side: –°—Ç–æ—Ä–æ–Ω–∞ –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ TP ('Buy' –∏–ª–∏ 'Sell')
        opposite_side: –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (–≤—Å–µ –µ—â–µ –æ—Ç–∫—Ä—ã—Ç–∞)

    Returns:
        reopen_margin: –ú–∞—Ä–∂–∞ –¥–ª—è –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è (–≤ USD)
    """
    # 1. –ü–æ–ª—É—á–∏—Ç—å –º–∞—Ä–∂—É –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
    opposite_margin = get_total_margin(opposite_side)

    # 2. –ü–æ–ª—É—á–∏—Ç—å —É—Ä–æ–≤–Ω–∏ (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å—Ç–∞—Ä–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    closed_level = 0  # –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
    opposite_level = get_grid_level(opposite_side)
    level_diff = opposite_level

    # 3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è –ù–ê –û–°–ù–û–í–ï MARGIN RATIO
    closed_initial_margin = initial_position_size_usd  # $1
    margin_ratio = opposite_margin / closed_initial_margin

    # –ï—Å–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –≤ 16√ó —Ä–∞–∑ –±–æ–ª—å—à–µ ‚Üí full reopen
    # –ï—Å–ª–∏ –≤ 8√ó —Ä–∞–∑ ‚Üí half reopen
    # –ï—Å–ª–∏ –≤ 4√ó —Ä–∞–∑ ‚Üí quarter reopen
    # –ï—Å–ª–∏ –≤ <4√ó —Ä–∞–∑ ‚Üí initial reopen

    if margin_ratio >= 16:
        reopen_coefficient = 1.0  # 100%
        logger.info(f"Large margin imbalance ({margin_ratio:.1f}√ó): 100% reopen")
    elif margin_ratio >= 8:
        reopen_coefficient = 0.5  # 50%
        logger.info(f"Medium margin imbalance ({margin_ratio:.1f}√ó): 50% reopen")
    elif margin_ratio >= 4:
        reopen_coefficient = 0.25  # 25%
        logger.info(f"Moderate margin imbalance ({margin_ratio:.1f}√ó): 25% reopen")
    else:
        # –ú–∞–ª—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å ‚Üí –æ–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞
        logger.info(f"Small margin imbalance ({margin_ratio:.1f}√ó): initial reopen")
        return closed_initial_margin  # $1

    # 4. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–∞—Ä–∂—É –¥–ª—è –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è
    reopen_margin = opposite_margin * reopen_coefficient

    logger.info(
        f"Adaptive reopen: opposite_margin=${opposite_margin:.2f}, "
        f"ratio={margin_ratio:.1f}√ó, coef={reopen_coefficient:.0%}, "
        f"reopen_margin=${reopen_margin:.2f}"
    )

    return reopen_margin
```

**–ü–æ—á–µ–º—É margin_ratio, –∞ –Ω–µ level_diff:**

```python
# –ü—Ä–∏–º–µ—Ä: –¶–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å $0.10 –¥–æ $0.15 (+50%)
# SHORT: level=5, –Ω–æ –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏—Å—å –ø—Ä–∏ $0.10

# –ü–æ —Å—Ç–∞—Ä–æ–π —Ñ–æ—Ä–º—É–ª–µ (level_diff):
# level_diff = 5 ‚Üí 100% reopen @ $0.15
# reopen_margin = $31
# reopen_qty = ($31 √ó 75) / $0.15 = 15,500 coins
# –ü–†–û–ë–õ–ï–ú–ê: SHORT –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç ~23,250 coins (–æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ ~$0.10)
# –î–∏—Å–±–∞–ª–∞–Ω—Å! –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã–ª–∏—Å—å —Å –º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–æ–Ω–µ—Ç

# –ü–æ –Ω–æ–≤–æ–π —Ñ–æ—Ä–º—É–ª–µ (margin_ratio):
# margin_ratio = $31 / $1 = 31√ó
# margin_ratio >= 16 ‚Üí 100% reopen
# reopen_margin = $31
# reopen_qty = ($31 √ó 75) / $0.15 = 15,500 coins

# –í–ê–ñ–ù–û: $31 –º–∞—Ä–∂–∏ @ $0.15 = –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –¢–ï–ö–£–©–ï–ô —Ü–µ–Ω—ã!
# –ú—ã —Ö–æ—Ç–∏–º $31 –º–∞—Ä–∂–∏, –Ω–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª-–≤–æ –º–æ–Ω–µ—Ç.
# Margin —É—Ä–∞–≤–Ω–æ–≤–µ—à–∏–≤–∞–µ—Ç—Å—è, –∞ qty –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ ‚úÖ
```

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ margin_ratio:**

```python
# –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ multiplier=2.0:
# Level 5: margin = 1+2+4+8+16 = 31 ‚Üí ratio = 31√ó ‚Üí 100% reopen ‚úÖ
# Level 4: margin = 1+2+4+8 = 15 ‚Üí ratio = 15√ó ‚Üí 50% reopen ‚úÖ
# Level 3: margin = 1+2+4 = 7 ‚Üí ratio = 7√ó ‚Üí 25% reopen ‚úÖ
# Level 2: margin = 1+2 = 3 ‚Üí ratio = 3√ó ‚Üí initial reopen ‚úÖ

# –ü—Ä–∏ multiplier=3.0:
# Level 3: margin = 1+3+9 = 13 ‚Üí ratio = 13√ó ‚Üí 50% reopen
# Level 4: margin = 1+3+9+27 = 40 ‚Üí ratio = 40√ó ‚Üí 100% reopen

# margin_ratio –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ multiplier! ‚úÖ
```

#### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞

```python
# –°—Ü–µ–Ω–∞—Ä–∏–π: –¢—Ä–µ–Ω–¥ –≤–≤–µ—Ä—Ö, SHORT —É—Å—Ä–µ–¥–Ω–∏–ª—Å—è 5 —Ä–∞–∑

# –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
SHORT = {
    'level': 5,
    'positions': [
        {'margin': 1, 'size': 75},    # –£—Ä–æ–≤–µ–Ω—å 0
        {'margin': 2, 'size': 150},   # –£—Ä–æ–≤–µ–Ω—å 1
        {'margin': 4, 'size': 300},   # –£—Ä–æ–≤–µ–Ω—å 2
        {'margin': 8, 'size': 600},   # –£—Ä–æ–≤–µ–Ω—å 3
        {'margin': 16, 'size': 1200}, # –£—Ä–æ–≤–µ–Ω—å 4
    ],
    'total_margin': 31,
    'total_size': 2325
}

LONG = {
    'level': 0,
    'positions': [
        {'margin': 1, 'size': 75}     # –ù–∞—á–∞–ª—å–Ω–∞—è
    ],
    'total_margin': 1,
    'total_size': 75
}

# LONG –¥–æ—Å—Ç–∏–≥–∞–µ—Ç TP –Ω–∞ —Ü–µ–Ω–µ $101 (+1%)

# –†–∞—Å—á–µ—Ç –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è LONG:
closed_side = 'Buy'
opposite_side = 'Sell'

closed_level = 0  # –ü–æ—Å–ª–µ TP
opposite_level = 5  # SHORT —É—Ä–æ–≤–µ–Ω—å
level_diff = 5 - 0 = 5

# level_diff >= 4 ‚Üí reopen_coefficient = 1.0 (100%)
opposite_margin = 31  # SHORT –º–∞—Ä–∂–∞
reopen_margin = 31 √ó 1.0 = 31

# –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å LONG —Å –º–∞—Ä–∂–æ–π $31
reopen_position_size = 31 √ó leverage = 31 √ó 75 = 2325

# –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è:
LONG_new = {
    'level': 5,  # –£—Ä–æ–≤–µ–Ω—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ä–∞–≤–Ω—ã–º SHORT
    'total_margin': 31,
    'total_size': 2325
}

SHORT = {
    'level': 5,
    'total_margin': 31,
    'total_size': 2325
}

# –°–ò–ú–ú–ï–¢–†–ò–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ê! ‚úÖ
```

### 2.3 –í–æ–∑–≤—Ä–∞—Ç –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é

**–í–æ–ø—Ä–æ—Å:** –ö–æ–≥–¥–∞ –æ–±–µ –ø–æ–∑–∏—Ü–∏–∏ –≤–µ—Ä–Ω—É—Ç—Å—è –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º ($1 –º–∞—Ä–∂–∞ –∫–∞–∂–¥–∞—è)?

**–û—Ç–≤–µ—Ç:** –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º TP –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ—Å–ª–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è.

```python
# –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞ –≤—ã—à–µ

# –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Å–∏–º–º–µ—Ç—Ä–∏—è):
LONG: level=5, margin=$31, size=$2,325
SHORT: level=5, margin=$31, size=$2,325

# –°—Ü–µ–Ω–∞—Ä–∏–π: –¶–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç –Ω–∞ 1%
# SHORT –¥–æ—Å—Ç–∏–≥–∞–µ—Ç TP –Ω–∞ —Ü–µ–Ω–µ $101 (-1% –æ—Ç —Å—Ä–µ–¥–Ω–µ–π $102)

# SHORT –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí –ø—Ä–æ—Ñ–∏—Ç
# SHORT –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è:

opposite_side = 'Buy'  # LONG
opposite_level = 5
opposite_margin = 31

closed_level = 0  # SHORT –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
level_diff = 5 - 0 = 5

# level_diff >= 4 ‚Üí reopen_coefficient = 1.0
reopen_margin = 31 √ó 1.0 = 31

# SHORT –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å –º–∞—Ä–∂–æ–π $31

# –ù–û! –ï—Å–ª–∏ —Ä—ã–Ω–æ–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–∞–¥–∞—Ç—å:
# LONG –¥–æ—Å—Ç–∏–≥–∞–µ—Ç TP —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 1%
# LONG –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Üí –ø—Ä–æ—Ñ–∏—Ç
# LONG –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è:

opposite_side = 'Sell'  # SHORT
opposite_level = 0  # SHORT –±—ã–ª –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ 0
opposite_margin = 31  # –ù–æ –º–∞—Ä–∂–∞ –≤—Å–µ –µ—â–µ $31 (–±—ã–ª –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π reopen)

level_diff = 0 - 0 = 0  # –û–ë–ê –Ω–∞ —É—Ä–æ–≤–Ω–µ 0!

# level_diff <= 1 ‚Üí reopen —Å –Ω–∞—á–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º!
reopen_margin = initial_position_size_usd = 1

# LONG –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å –º–∞—Ä–∂–æ–π $1

# –°–ª–µ–¥—É—é—â–∏–π TP SHORT –ø—Ä–∏ level_diff=0:
# SHORT —Ç–∞–∫–∂–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å $1

# –í–û–ó–í–†–ê–¢ –ö –ù–ê–ß–ê–õ–¨–ù–û–ú–£ –°–û–°–¢–û–Ø–ù–ò–Æ! ‚úÖ
LONG: level=0, margin=$1, size=$75
SHORT: level=0, margin=$1, size=$75
```

**–í—ã–≤–æ–¥:** –ü–æ–∑–∏—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –ø–æ—Å–ª–µ 2-3 —Ü–∏–∫–ª–æ–≤ TP –≤ —É—Å–ª–æ–≤–∏—è—Ö –±–æ–∫–æ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞.

### 2.4 –ü—Å–µ–≤–¥–æ–∫–æ–¥ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è

```python
def on_position_closed_by_tp(closed_side: str, close_price: float):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–æ Take Profit

    Args:
        closed_side: 'Buy' (LONG –∑–∞–∫—Ä—ã–ª—Å—è) –∏–ª–∏ 'Sell' (SHORT –∑–∞–∫—Ä—ã–ª—Å—è)
        close_price: –¶–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
    """
    # 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
    opposite_side = 'Sell' if closed_side == 'Buy' else 'Buy'

    # 2. –ü–æ–ª—É—á–∏—Ç—å —É—Ä–æ–≤–Ω–∏
    closed_level = 0  # –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
    opposite_level = position_manager.get_grid_level(opposite_side)
    level_diff = abs(opposite_level - closed_level)

    # 3. –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
    opposite_margin = position_manager.get_total_margin(opposite_side)

    # 4. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è
    if level_diff >= 4:
        reopen_margin = opposite_margin  # 100%
        logger.info(f"Large imbalance (diff={level_diff}): reopen with 100% opposite size")
    elif level_diff == 3:
        reopen_margin = opposite_margin * 0.5  # 50%
        logger.info(f"Medium imbalance (diff={level_diff}): reopen with 50% opposite size")
    elif level_diff == 2:
        reopen_margin = opposite_margin * 0.25  # 25%
        logger.info(f"Moderate imbalance (diff={level_diff}): reopen with 25% opposite size")
    else:
        reopen_margin = initial_position_size_usd  # –ù–∞—á–∞–ª—å–Ω—ã–π
        logger.info(f"Small imbalance (diff={level_diff}): reopen with initial size")

    # 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å IM
    available_for_trading = calculate_available_for_trading()
    safety_reserve = calculate_safety_reserve()

    if available_for_trading < reopen_margin + safety_reserve:
        # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ IM –¥–ª—è –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è —Å –∂–µ–ª–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
        logger.warning(f"Insufficient IM for full reopen: available={available_for_trading}, needed={reopen_margin}")

        # –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        max_reopen_margin = available_for_trading - safety_reserve

        if max_reopen_margin > 0:
            reopen_margin = max_reopen_margin
            logger.info(f"Reopening with reduced size: {reopen_margin}")
        else:
            # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è - –¥–∞–∂–µ –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –Ω–µ –æ—Ç–∫—Ä—ã—Ç—å
            logger.error("Cannot reopen: insufficient IM even for minimal position")
            # –ù–ï –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤
            return

    # 6. –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é
    reopen_qty = margin_to_qty(reopen_margin, close_price, leverage)

    if not dry_run:
        bybit_client.place_order(
            symbol=symbol,
            side=closed_side,
            qty=reopen_qty,
            order_type='Market'
        )

    # 7. –û–±–Ω–æ–≤–∏—Ç—å position manager
    # –£—Ä–æ–≤–µ–Ω—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–≤–Ω—ã–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è)
    new_level = opposite_level if level_diff >= 4 else 0

    position_manager.add_position(
        side=closed_side,
        entry_price=close_price,
        quantity=reopen_qty,
        grid_level=new_level
    )

    # 8. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TP –æ—Ä–¥–µ—Ä
    update_tp_order(closed_side)

    logger.info(
        f"Reopened {closed_side}: margin=${reopen_margin:.2f}, "
        f"size=${reopen_qty * close_price:.2f}, level={new_level}"
    )
```

---

## 3. Initial Margin —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### 3.1 –†–∞—Å—á–µ—Ç safety_reserve (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –∞–∫–∫–∞—É–Ω—Ç–∞)

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:**
- ‚úÖ –†–µ–∑–µ—Ä–≤ –≤ USD –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ –ø–æ–∑–∏—Ü–∏–π –≤ **–ú–û–ù–ï–¢–ê–•** (SOL, DOGE, TON)
- ‚úÖ –†–µ–∑–µ—Ä–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ **–ê–ö–ö–ê–£–ù–¢–ê** (—Å—É–º–º–∏—Ä—É–µ—Ç –í–°–ï —Ç–æ—Ä–≥—É–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã)
- ‚úÖ –†–µ–∑–µ—Ä–≤ **–î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô** (–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–π –ò–õ–ò —Ü–µ–Ω—ã)
- ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º —É—Ä–æ–≤–Ω–∏ grid (—Ü–µ–Ω–∞ –º–µ–Ω—è–µ—Ç—Å—è!)
- ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º worst-case –¥–ª—è max_grid_levels (–±–æ–º–±–∞ –∑–∞–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è!)

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
```python
# –î–ª—è –ö–ê–ñ–î–û–ì–û —Å–∏–º–≤–æ–ª–∞ –∞–∫–∫–∞—É–Ω—Ç–∞:
imbalance_coins = |LONG_qty - SHORT_qty|  # –í –º–æ–Ω–µ—Ç–∞—Ö (SOL, DOGE, TON)
symbol_reserve = imbalance_coins * current_price

# –†–µ–∑–µ—Ä–≤ –∞–∫–∫–∞—É–Ω—Ç–∞ = —Å—É–º–º–∞ —Ä–µ–∑–µ—Ä–≤–æ–≤ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤
account_reserve = sum(symbol_reserves) * safety_factor
```

#### 3.1.1 –†–∞—Å—á–µ—Ç —Ä–µ–∑–µ—Ä–≤–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∞–∫–∫–∞—É–Ω—Ç–∞

```python
# –í TradingAccount (–ù–ï –≤ GridStrategy!)
def calculate_account_safety_reserve(self) -> float:
    """
    –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–µ–∑–µ—Ä–≤ –¥–ª—è –í–°–ï–• —Å–∏–º–≤–æ–ª–æ–≤ –∞–∫–∫–∞—É–Ω—Ç–∞

    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è:
    - –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–π (—É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ, TP)
    - –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã (–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É)
    - –ü–µ—Ä–µ–¥ –ö–ê–ñ–î–´–ú —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º –ª—é–±–æ–≥–æ —Å–∏–º–≤–æ–ª–∞

    Returns:
        safety_reserve: –†–µ–∑–µ—Ä–≤ –≤ USD –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤
    """
    total_reserve_usd = 0.0
    reserve_details = []

    # –ü—Ä–æ–π—Ç–∏ –ø–æ –í–°–ï–ú —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º —ç—Ç–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
    for strategy in self.strategies:
        symbol = strategy.symbol

        # 1. –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –ø–æ–∑–∏—Ü–∏–π –≤ –ú–û–ù–ï–¢–ê–• (DOGE, TON, SOL)
        long_qty = strategy.position_manager.get_total_quantity('Buy')   # 100 DOGE
        short_qty = strategy.position_manager.get_total_quantity('Sell') # 500 DOGE

        # 2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–∏—Å–±–∞–ª–∞–Ω—Å –≤ –ú–û–ù–ï–¢–ê–•
        imbalance_qty = abs(long_qty - short_qty)  # 400 DOGE

        # 3. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É —Å–∏–º–≤–æ–ª–∞ (–º–µ–Ω—è–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ!)
        current_price = strategy.get_current_price()  # $0.15

        # 4. –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ –≤ USD
        imbalance_usd = imbalance_qty * current_price  # 400 * 0.15 = $60

        # 5. –î–æ–±–∞–≤–∏—Ç—å –∫ –æ–±—â–µ–º—É —Ä–µ–∑–µ—Ä–≤—É
        total_reserve_usd += imbalance_usd

        reserve_details.append({
            'symbol': symbol,
            'long_qty': long_qty,
            'short_qty': short_qty,
            'imbalance_qty': imbalance_qty,
            'price': current_price,
            'reserve_usd': imbalance_usd
        })

        self.logger.debug(
            f"  {symbol}: {imbalance_qty:.2f} coins √ó ${current_price:.4f} = ${imbalance_usd:.2f}"
        )

    # 6. Safety factor (–∫–æ–º–∏—Å—Å–∏–∏, —Ñ–∞–Ω–¥–∏–Ω–≥–∏, –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è)
    # +10% –∑–∞–ø–∞—Å –Ω–∞:
    # - –ö–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ (taker ~0.055%)
    # - –ù–µ–±–æ–ª—å—à–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –≤–æ –≤—Ä–µ–º—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
    # - –û–∫—Ä—É–≥–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–æ–Ω–µ—Ç
    safety_factor = 1.1
    final_reserve = total_reserve_usd * safety_factor

    self.logger.info(
        f"[Account {self.account_id}] Safety reserve: "
        f"${total_reserve_usd:.2f} √ó {safety_factor} = ${final_reserve:.2f} "
        f"(symbols: {len(self.strategies)})"
    )

    return final_reserve


# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
# –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ TradingAccount
account_reserve = trading_account.calculate_account_safety_reserve()
```

**–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä (–º—É–ª—å—Ç–∏—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç):**

```python
# Account 1 (UNIFIED –±–∞–ª–∞–Ω—Å $10,000)
# –¢–æ—Ä–≥—É–µ—Ç 2 —Å–∏–º–≤–æ–ª–∞: DOGEUSDT + TONUSDT

# DOGEUSDT:
#   LONG: 100 DOGE (—Ü–µ–Ω–∞ $0.15)
#   SHORT: 500 DOGE (—Ü–µ–Ω–∞ $0.15)
#   –î–∏—Å–±–∞–ª–∞–Ω—Å: |100 - 500| = 400 DOGE
#   –†–µ–∑–µ—Ä–≤: 400 * $0.15 = $60

# TONUSDT:
#   LONG: 10 TON (—Ü–µ–Ω–∞ $5.00)
#   SHORT: 50 TON (—Ü–µ–Ω–∞ $5.00)
#   –î–∏—Å–±–∞–ª–∞–Ω—Å: |10 - 50| = 40 TON
#   –†–µ–∑–µ—Ä–≤: 40 * $5.00 = $200

# –ò–¢–û–ì–û —Ä–µ–∑–µ—Ä–≤:
#   –°—É–º–º–∞: $60 + $200 = $260
#   –° safety_factor: $260 * 1.1 = $286

# –ü—Ä–∏ —Ä–æ—Å—Ç–µ —Ü–µ–Ω—ã DOGE –¥–æ $0.20:
#   DOGE —Ä–µ–∑–µ—Ä–≤: 400 * $0.20 = $80 (+$20!)
#   TON —Ä–µ–∑–µ—Ä–≤: 40 * $5.00 = $200 (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
#   –ò–¢–û–ì–û: ($80 + $200) * 1.1 = $308 (+$22!)

# –ü—Ä–∏ —Ä–æ—Å—Ç–µ —Ü–µ–Ω—ã TON –¥–æ $6.00:
#   DOGE —Ä–µ–∑–µ—Ä–≤: 400 * $0.20 = $80
#   TON —Ä–µ–∑–µ—Ä–≤: 40 * $6.00 = $240 (+$40!)
#   –ò–¢–û–ì–û: ($80 + $240) * 1.1 = $352 (+$44!)
```

#### 3.1.2 Safety Factor: –ö–æ–º–∏—Å—Å–∏–∏, Gap Buffer, Tier Buffer

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω safety factor –±–æ–ª—å—à–µ 1.0?**

–†–µ–∑–µ—Ä–≤ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –¥–∏—Å–±–∞–ª–∞–Ω—Å –≤ –º–æ–Ω–µ—Ç–∞—Ö √ó —Ü–µ–Ω–∞, –Ω–æ —Ü–µ–Ω–∞ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –î–û –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–≤ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏!

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã safety factor:**

1. **Base buffer (–∫–æ–º–∏—Å—Å–∏–∏ + –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è):** +10%
2. **Gap buffer (–ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ/–≥—ç–ø—ã):** +2% –¥–æ +10% (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç ATR)
3. **Tier buffer (Portfolio Margin tiers):** +5% –ø–æ—Å—Ç–æ—è–Ω–Ω–æ

**–§–æ—Ä–º—É–ª–∞:**

```python
def calculate_safety_factor(atr_percent: float) -> float:
    """
    –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π safety factor

    Args:
        atr_percent: ATR –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç —Ü–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.5%)

    Returns:
        safety_factor: –ò—Ç–æ–≥–æ–≤—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (1.17 - 1.25)
    """
    # 1. Base buffer: –∫–æ–º–∏—Å—Å–∏–∏ + –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
    base_buffer = 0.10  # +10%

    # 2. Gap buffer: –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è
    # –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ —Ü–µ–Ω–∞ –º–æ–∂–µ—Ç —É—Å–∫–∞–∫–∞—Ç—å
    if atr_percent < 1.0:
        gap_buffer = 0.02  # +2% (–Ω–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)
    elif atr_percent < 2.0:
        gap_buffer = 0.05  # +5% (—Å—Ä–µ–¥–Ω—è—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)
    else:
        gap_buffer = 0.10  # +10% (–≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)

    # 3. Tier buffer: Portfolio Margin non-linearity
    tier_buffer = 0.05  # +5% (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∑–∞–ø–∞—Å –Ω–∞ tier rates)

    # –ò—Ç–æ–≥–æ
    safety_factor = 1.0 + base_buffer + gap_buffer + tier_buffer

    return safety_factor

# –ü—Ä–∏–º–µ—Ä—ã:
# ATR = 0.8% ‚Üí safety_factor = 1.0 + 0.10 + 0.02 + 0.05 = 1.17
# ATR = 1.5% ‚Üí safety_factor = 1.0 + 0.10 + 0.05 + 0.05 = 1.20
# ATR = 2.5% ‚Üí safety_factor = 1.0 + 0.10 + 0.10 + 0.05 = 1.25
```

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–µ–∑–µ—Ä–≤–∞ –≤ TradingAccount:**

```python
# –í TradingAccount.calculate_account_safety_reserve()

# 1. –ë–∞–∑–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤ (—Å—É–º–º–∞ –¥–∏—Å–±–∞–ª–∞–Ω—Å–æ–≤ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤)
base_reserve_usd = 0.0
for strategy in self.strategies:
    imbalance_qty = abs(long_qty - short_qty)
    imbalance_usd = imbalance_qty * current_price
    base_reserve_usd += imbalance_usd

# 2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å ATR (—Å—Ä–µ–¥–Ω–∏–π –ø–æ –≤—Å–µ–º —Å–∏–º–≤–æ–ª–∞–º –∏–ª–∏ worst-case)
atr_values = []
for strategy in self.strategies:
    atr_percent = strategy.calculate_atr_percent()  # –ú–µ—Ç–æ–¥ –≤ GridStrategy
    atr_values.append(atr_percent)

# –í–∑—è—Ç—å worst-case (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π ATR)
max_atr_percent = max(atr_values) if atr_values else 1.5

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å safety factor
safety_factor = calculate_safety_factor(max_atr_percent)
final_reserve = base_reserve_usd * safety_factor

self.logger.info(
    f"[Account {self.account_id}] Safety reserve: "
    f"base=${base_reserve_usd:.2f}, ATR={max_atr_percent:.2f}%, "
    f"factor={safety_factor:.2f}, final=${final_reserve:.2f}"
)

# –ü—Ä–∏–º–µ—Ä:
# base_reserve = $400 (–¥–∏—Å–±–∞–ª–∞–Ω—Å—ã –ø–æ –≤—Å–µ–º —Å–∏–º–≤–æ–ª–∞–º)
# max_atr = 1.5%
# safety_factor = 1.20
# final_reserve = $400 √ó 1.20 = $480
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ? –ü—Ä–∏–º–µ—Ä —Å –≥—ç–ø–æ–º:**

```python
# –°—Ü–µ–Ω–∞—Ä–∏–π: ATR = 2%, gap_buffer = 10%
# –î–∏—Å–±–∞–ª–∞–Ω—Å: 500 DOGE @ $0.15 = $75
# –†–µ–∑–µ—Ä–≤: $75 √ó 1.25 = $93.75

# ‚ùå –ë–ï–ó gap buffer (—Å—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥):
# reserve = $75 √ó 1.10 = $82.50
# –¶–µ–Ω–∞ –ø—Ä—ã–≥–∞–µ—Ç –Ω–∞ 3% –≤–æ –≤—Ä–µ–º—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏: $0.15 ‚Üí $0.1545
# –†–µ–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: 500 √ó $0.1545 = $77.25
# –ö–æ–º–∏—Å—Å–∏–∏: $77.25 √ó 0.055% = $0.04
# –ò–¢–û–ì–û –Ω—É–∂–Ω–æ: $77.25 + $0.04 = $77.29
# –ü–†–û–ë–õ–ï–ú–ê: $82.50 –µ–¥–≤–∞ —Ö–≤–∞—Ç–∞–µ—Ç! –ó–∞–ø–∞—Å –≤—Å–µ–≥–æ $5.21

# ‚úÖ –° gap buffer (–Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥):
# reserve = $75 √ó 1.25 = $93.75
# –¶–µ–Ω–∞ –ø—Ä—ã–≥–∞–µ—Ç: 500 √ó $0.1545 = $77.25 + $0.04 = $77.29
# –û—Å—Ç–∞—Ç–æ–∫: $93.75 - $77.29 = $16.46 ‚úÖ –ö–û–ú–§–û–†–¢–ù–´–ô –ó–ê–ü–ê–°!
```

**–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**

1. **Base buffer (+10%):**
   - –ö–æ–º–∏—Å—Å–∏–∏ taker: ~0.055%
   - –û–∫—Ä—É–≥–ª–µ–Ω–∏—è qty –¥–æ step size
   - –ú–µ–ª–∫–∏–µ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç–æ–≤

2. **Gap buffer (+2% –¥–æ +10%):**
   - –ü—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (slippage)
   - –ì—ç–ø—ã –º–µ–∂–¥—É check –∏ execute
   - –í–Ω–µ–∑–∞–ø–Ω—ã–µ —Å–∫–∞—á–∫–∏ —Ü–µ–Ω—ã
   - **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π** –Ω–∞ –æ—Å–Ω–æ–≤–µ ATR!

3. **Tier buffer (+5%):**
   - Portfolio Margin tier rates
   - –ù–µ–ª–∏–Ω–µ–π–Ω–æ—Å—Ç—å IM (–¥–µ—Ç–∞–ª–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ 3.4)
   - –ó–∞–ø–∞—Å –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Å–ª–µ–¥—É—é—â–∏–π tier

**–í—ã–≤–æ–¥:** Safety factor 1.17-1.25 (–≤–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ 1.10) –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π!

### 3.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–∞ –ø–µ—Ä–µ–¥ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º (–Ω–∞ —É—Ä–æ–≤–Ω–µ –∞–∫–∫–∞—É–Ω—Ç–∞!)

**–í–ê–ñ–ù–û:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ TradingAccount –ø–µ—Ä–µ–¥ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º –õ–Æ–ë–û–ì–û —Å–∏–º–≤–æ–ª–∞!

```python
# –í TradingAccount
def check_reserve_before_averaging(
    self,
    symbol: str,
    side: str,
    next_averaging_margin: float
) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Ä–µ–∑–µ—Ä–≤–∞ –ø–µ—Ä–µ–¥ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø!)

    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ê–ö–ö–ê–£–ù–¢–ê –ø–µ—Ä–µ–¥ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º –õ–Æ–ë–û–ì–û —Å–∏–º–≤–æ–ª–∞.
    –£—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∏—Å–±–∞–ª–∞–Ω—Å—ã –ø–æ –í–°–ï–ú —Ç–æ—Ä–≥—É–µ–º—ã–º —Å–∏–º–≤–æ–ª–∞–º.

    Args:
        symbol: –°–∏–º–≤–æ–ª –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—Ç —É—Å—Ä–µ–¥–Ω–∏—Ç—å—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'DOGEUSDT')
        side: –°—Ç–æ—Ä–æ–Ω–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è ('Buy' –∏–ª–∏ 'Sell')
        next_averaging_margin: –ú–∞—Ä–∂–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è

    Returns:
        True –µ—Å–ª–∏ –º–æ–∂–Ω–æ —É—Å—Ä–µ–¥–Ω—è—Ç—å—Å—è, False –µ—Å–ª–∏ –Ω–µ—Ç
    """
    # 1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Wallet WebSocket cache (real-time!)
    # –ù–µ—Ç REST API –≤—ã–∑–æ–≤–æ–≤ - –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket –≤ —Ñ–æ–Ω–µ
    total_balance = self.balance_manager.get_available_balance()  # totalAvailableBalance (–£–ñ–ï –≤—ã—á–µ–ª IM!)
    total_im = self.balance_manager.get_initial_margin()  # –î–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏/–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

    # 2. –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ –¥–ª—è –í–°–ï–• —Å–∏–º–≤–æ–ª–æ–≤ –∞–∫–∫–∞—É–Ω—Ç–∞
    # –†–µ–∑–µ—Ä–≤ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ö–ê–ñ–î–´–ô –†–ê–ó –ø–µ—Ä–µ–¥ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º!
    safety_reserve = self.calculate_account_safety_reserve()

    # 3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (–ë–ï–ó –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã—á–∏—Ç–∞–Ω–∏—è IM!)
    available_for_trading = total_balance - safety_reserve  # total_balance –£–ñ–ï –≤—ã—á–µ–ª IM!

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞
    if available_for_trading >= next_averaging_margin:
        self.logger.info(
            f"[{symbol}] Reserve check PASSED: "
            f"available=${available_for_trading:.2f}, "
            f"needed=${next_averaging_margin:.2f}, "
            f"reserve=${safety_reserve:.2f} (all symbols)"
        )
        return True
    else:
        self.logger.warning(
            f"[{symbol}] Reserve check FAILED: "
            f"available=${available_for_trading:.2f}, "
            f"needed=${next_averaging_margin:.2f}, "
            f"reserve=${safety_reserve:.2f} (all symbols). "
            f"BLOCKING averaging to preserve emergency funds!"
        )
        return False


# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ GridStrategy
def should_execute_averaging(self, side: str, current_price: float) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –¥–ª—è –≠–¢–û–ì–û —Å–∏–º–≤–æ–ª–∞

    Returns:
        True –µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
    """
    # 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if not self.should_add_position(side, current_price):
        return False

    if self.position_manager.get_position_count(side) >= self.max_grid_levels:
        return False

    # 2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–∞—Ä–∂—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    next_margin = self.calculate_next_averaging_margin(side)

    # 3. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –†–ï–ó–ï–†–í–ê –ù–ê –£–†–û–í–ù–ï –ê–ö–ö–ê–£–ù–¢–ê
    # –û–±—Ä–∞—â–∞–µ–º—Å—è –∫ TradingAccount –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑–µ—Ä–≤–∞ –í–°–ï–• —Å–∏–º–≤–æ–ª–æ–≤
    if not self.trading_account.check_reserve_before_averaging(
        symbol=self.symbol,
        side=side,
        next_averaging_margin=next_margin
    ):
        # –†–µ–∑–µ—Ä–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω ‚Üí –ë–õ–û–ö–ò–†–û–í–ê–¢–¨ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ
        # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—É (–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ)
        return False

    # 4. –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
    return True
```

**–ü—Ä–∏–º–µ—Ä (–º—É–ª—å—Ç–∏—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç):**

```python
# Account 1: —Ç–æ—Ä–≥—É–µ—Ç DOGEUSDT + TONUSDT
# –ë–∞–ª–∞–Ω—Å: $10,000
# Used IM: $3,000

# –¢–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏:
# DOGEUSDT: LONG 100, SHORT 500 ‚Üí –¥–∏—Å–±–∞–ª–∞–Ω—Å 400 DOGE √ó $0.15 = $60
# TONUSDT: LONG 10, SHORT 50 ‚Üí –¥–∏—Å–±–∞–ª–∞–Ω—Å 40 TON √ó $5.00 = $200

# –†–µ–∑–µ—Ä–≤ –∞–∫–∫–∞—É–Ω—Ç–∞:
safety_reserve = ($60 + $200) * 1.1 = $286

# DOGEUSDT —Ö–æ—á–µ—Ç —É—Å—Ä–µ–¥–Ω–∏—Ç—å—Å—è (–Ω—É–∂–Ω–æ $2 –º–∞—Ä–∂–∏):
available = $10,000 - $3,000 - $286 = $6,714
needed = $2
# CHECK: $6,714 >= $2 ‚úÖ PASSED

# –ü–æ—Å–ª–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è DOGEUSDT –¥–∏—Å–±–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è:
# DOGEUSDT: LONG 100, SHORT 600 ‚Üí –¥–∏—Å–±–∞–ª–∞–Ω—Å 500 DOGE √ó $0.15 = $75 (+$15!)
# –†–µ–∑–µ—Ä–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–µ!
```

### 3.3 –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ IM

```python
def monitor_initial_margin():
    """
    –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Initial Margin (–≤—ã–∑—ã–≤–∞—Ç—å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)

    –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç:
    - –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π IM
    - –î–æ—Å—Ç—É–ø–Ω—ã–π IM
    - –ü—Ä–æ—Ü–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    - –ë–ª–∏–∑–æ—Å—Ç—å –∫ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—é —Ä–µ–∑–µ—Ä–≤–∞
    """
    # –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Wallet WebSocket cache (real-time, –±–µ–∑ REST API!)
    total_balance = balance_manager.get_available_balance()  # totalAvailableBalance (–£–ñ–ï –≤—ã—á–µ–ª IM!)
    total_im = balance_manager.get_initial_margin()  # –î–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏/–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    account_mm_rate = balance_manager.get_mm_rate()  # –£–∂–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (0.15% = 0.15)

    # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏
    safety_reserve = calculate_account_safety_reserve()  # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –∞–∫–∫–∞—É–Ω—Ç–∞
    available_for_trading = total_balance - safety_reserve  # –ë–ï–ó –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã—á–∏—Ç–∞–Ω–∏—è IM!
    available_percent = (available_for_trading / total_balance) * 100

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    logger.info(
        f"IM Status: balance=${total_balance:.2f}, used_IM=${total_im:.2f}, "
        f"available=${available_for_trading:.2f} ({available_percent:.1f}%), "
        f"reserve=${safety_reserve:.2f}, MM_Rate={account_mm_rate:.2f}%"
    )

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    if available_percent < 30:
        logger.warning(f"LOW AVAILABLE IM: {available_percent:.1f}% - approaching panic mode")

    if available_percent < 15:
        logger.error(f"CRITICAL AVAILABLE IM: {available_percent:.1f}% - entering panic mode soon")

    if available_for_trading < 0:
        logger.critical(
            f"RESERVE BREACHED: available=${available_for_trading:.2f} < 0! "
            f"Safety reserve has been used!"
        )

    return {
        'total_balance': total_balance,
        'total_im': total_im,
        'available_for_trading': available_for_trading,
        'available_percent': available_percent,
        'safety_reserve': safety_reserve,
        'account_mm_rate': account_mm_rate
    }
```

### 3.4 Portfolio Margin Non-Linearity (Tier Rates)

**‚ö†Ô∏è –í–ê–ñ–ù–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï:**

–§–æ—Ä–º—É–ª–∞ `margin = (qty √ó price) / leverage` - —ç—Ç–æ **—É–ø—Ä–æ—â–µ–Ω–∏–µ**!

–í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ Bybit Unified Account –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **tiered Initial Margin rates** (risk limits):

```python
# –ü—Ä–∏–º–µ—Ä –¥–ª—è SOLUSDT (leverage 75√ó)
# Tier 1: 0-10,000 contracts
#   ‚Üí IM rate = 1.33% (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 1/75)
#
# Tier 2: 10,000-50,000 contracts
#   ‚Üí IM rate = 2.00% (–í–´–®–ï —á–µ–º 1/75!)
#
# Tier 3: 50,000-100,000 contracts
#   ‚Üí IM rate = 3.00% (–ï–©–ï –í–´–®–ï!)

# –ü—Ä–æ–±–ª–µ–º–∞:
# –ü—Ä–∏ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏—è –º–æ–∂–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π tier!
# Real IM > Estimated IM

# –ü—Ä–∏–º–µ—Ä:
# –ü–æ–∑–∏—Ü–∏—è: 9,000 contracts @ $150 = $1,350,000 notional
# Estimated IM: $1,350,000 / 75 = $18,000
# Real IM (Tier 1): $1,350,000 √ó 1.33% = $17,955 ‚úÖ –±–ª–∏–∑–∫–æ

# –ü–æ—Å–ª–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è: 12,000 contracts @ $150 = $1,800,000
# Estimated IM: $1,800,000 / 75 = $24,000
# Real IM (Tier 2): $1,800,000 √ó 2.00% = $36,000 ‚ùå –Ω–∞ 50% –±–æ–ª—å—à–µ!
```

**–ü—Ä–∏–º–µ—Ä—ã tier rates –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤:**

| –°–∏–º–≤–æ–ª | Tier 1 | Tier 1 IM | Tier 2 | Tier 2 IM | Tier 3 | Tier 3 IM |
|--------|--------|-----------|--------|-----------|--------|-----------|
| SOLUSDT | 0-10K | 1.33% | 10K-50K | 2.00% | 50K-100K | 3.00% |
| DOGEUSDT | 0-500K | 1.33% | 500K-2.5M | 2.00% | 2.5M-5M | 3.00% |
| TONUSDT | 0-5K | 1.33% | 5K-25K | 2.00% | 25K-50K | 3.00% |

**–ü–æ—á–µ–º—É WebSocket-first –ø–æ–¥—Ö–æ–¥ —Ä–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É:**

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø–æ–¥—Ö–æ–¥ (WebSocket-first):
# –ú—ã –ù–ï —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º IM —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ!
# –ú—ã –±–µ—Ä–µ–º REAL IM –∏–∑ WebSocket:

total_im = balance_manager.get_initial_margin()  # Real IM –æ—Ç –±–∏—Ä–∂–∏
# –ë–∏—Ä–∂–∞ –£–ñ–ï —É—á–ª–∞ tier rates, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚úÖ

# –ü—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ –≤ –û–¶–ï–ù–ö–ê–• (estimate next IM):
next_margin_estimated = calculate_next_averaging_margin(side)
# –≠—Ç–∞ –æ—Ü–µ–Ω–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω–∏–∂–µ–Ω–∞ –µ—Å–ª–∏ tier upgrade –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç!
```

**–†–µ—à–µ–Ω–∏–µ: Tier Buffer –≤ safety_factor**

```python
# –í calculate_safety_factor() –º—ã –¥–æ–±–∞–≤–∏–ª–∏ tier_buffer = 5%
# –≠—Ç–æ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç tier rate —É–≤–µ–ª–∏—á–µ–Ω–∏–µ

# –ï—Å–ª–∏ estimate –∑–∞–Ω–∏–∂–µ–Ω –Ω–∞ 20-50%, –∞ reserve √ó 1.20-1.25:
# Reserve –ø–æ–∫—Ä–æ–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É!

# –ü—Ä–∏–º–µ—Ä:
# Estimated next_margin = $20 (–∑–∞–Ω–∏–∂–µ–Ω –∏–∑-–∑–∞ tier)
# Real next_margin = $25 (tier upgrade –≤–æ –≤—Ä–µ–º—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è)
# Available = $100, reserve = $50 √ó 1.20 = $60

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º:
# available_for_trading = $100 - $60 = $40
# $40 >= $20? ‚úÖ –î–ê (–ø–æ estimate)

# Real execution: –Ω—É–∂–Ω–æ $25
# $40 >= $25? ‚úÖ –î–ê! (tier buffer + gap buffer –ø–æ–∫—Ä—ã–ª–∏ —Ä–∞–∑–Ω–∏—Ü—É)
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):**

```python
# ‚ùå Pre-trade margin estimation —á–µ—Ä–µ–∑ REST API:
# estimated_im = bybit_client.get_pre_trade_margin(symbol, side, qty)

# –ü–æ—á–µ–º—É –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º:
# 1. REST API –≤—ã–∑–æ–≤ ‚Üí –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç WebSocket-first –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
# 2. –ó–∞–¥–µ—Ä–∂–∫–∞ (50-200ms) ‚Üí —Ü–µ–Ω–∞ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
# 3. –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–º (–±–∏—Ä–∂–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞)
# 4. Safety factor 1.20-1.25 –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –±–µ–∑ REST API!
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: Early Freeze (—Å–º. —Ä–∞–∑–¥–µ–ª 3.5)**

```python
# Early Freeze –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –î–û –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞
# –≠—Ç–æ –¥–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø–∞—Å –Ω–∞ tier upgrade
```

**–í—ã–≤–æ–¥:**
- ‚úÖ WebSocket –¥–∞–µ—Ç REAL IM (—É–∂–µ —É—á—Ç–µ–Ω—ã tiers)
- ‚úÖ Safety factor 1.20-1.25 –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç tier –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ estimates
- ‚úÖ Tier buffer (+5%) —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è Portfolio Margin non-linearity
- ‚úÖ Early Freeze –¥–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∑–∞—â–∏—Ç—É
- ‚ùå –ù–ï –Ω—É–∂–µ–Ω REST API –¥–ª—è pre-trade estimation
- ‚úÖ 100% –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

### 3.5 Early Freeze: –ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**

–ù–ï –∂–¥–∞—Ç—å –ø–∞–Ω–∏–∫–∏! –ó–∞–º–æ—Ä–æ–∑–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –ó–ê–†–ê–ù–ï–ï, –∫–∞–∫ —Ç–æ–ª—å–∫–æ —Ä–µ–∑–µ—Ä–≤–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∞—Ç—å.

**–¢—Ä–∏–≥–≥–µ—Ä early freeze:**

```python
def check_early_freeze_trigger() -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–º–æ—Ä–æ–∑–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–æ

    –¢—Ä–∏–≥–≥–µ—Ä: Available IM –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è next averaging + –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –∑–∞–ø–∞—Å

    Returns:
        True –µ—Å–ª–∏ –Ω—É–∂–Ω–æ freeze, False –µ—Å–ª–∏ –≤—Å–µ –û–ö
    """
    # 1. –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–∏–∑ WebSocket cache)
    total_available = balance_manager.get_available_balance()
    safety_reserve = calculate_account_safety_reserve()  # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π!

    available_for_trading = total_available - safety_reserve

    # 2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å worst-case —Å–ª–µ–¥—É—é—â–µ–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ (–¥–ª—è –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤)
    next_margins = []
    for strategy in self.strategies:
        for side in ['Buy', 'Sell']:
            next_margin = strategy.calculate_next_averaging_margin(side)
            next_margins.append(next_margin)

    next_worst_case = sum(next_margins)  # –ï—Å–ª–∏ –í–°–ï —Å–∏–º–≤–æ–ª—ã —É—Å—Ä–µ–¥–Ω—è—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

    # 3. –ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –∑–∞–ø–∞—Å: 1.5√ó next_worst_case
    # (–•–æ—Ç–∏–º –∏–º–µ—Ç—å –∑–∞–ø–∞—Å –Ω–∞ 1.5 —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è, –Ω–µ –ø—Ä–æ—Å—Ç–æ "—Ö–≤–∞—Ç–∞–µ—Ç –≤–ø—Ä–∏—Ç—ã–∫")
    comfort_threshold = next_worst_case * 1.5

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞
    if available_for_trading < comfort_threshold:
        return True

    return False

# –ü—Ä–∏–º–µ—Ä:
# available_for_trading = $200
# next_worst_case = $150 (–µ—Å–ª–∏ –≤—Å–µ —Å–∏–º–≤–æ–ª—ã —É—Å—Ä–µ–¥–Ω—è—Ç—Å—è)
# comfort_threshold = $150 √ó 1.5 = $225
# $200 < $225? ‚úÖ –î–ê ‚Üí FREEZE!
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –≥–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª:**

```python
# –í TradingAccount –∏–ª–∏ main loop
def handle_normal_operation(current_price: float):
    """
    –û–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å early freeze –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    """
    # 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å early freeze –ü–ï–†–ï–î —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è–º–∏
    if check_early_freeze_trigger():
        if not averaging_frozen:
            logger.warning(
                "‚ö†Ô∏è EARLY FREEZE ACTIVATED: Insufficient IM for comfortable operation. "
                "Blocking all averaging operations until IM recovers."
            )
            freeze_all_averaging()
            averaging_frozen = True

        # –ù–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É TP
        # TP –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç IM ‚Üí –º–æ–∂–µ—Ç —Ä–∞–∑–º–æ—Ä–æ–∑–∏—Ç—å
        return

    # 2. –ï—Å–ª–∏ –±—ã–ª–æ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ, –Ω–æ —Ç–µ–ø–µ—Ä—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å
    if averaging_frozen and not check_early_freeze_trigger():
        logger.info("‚úÖ IM recovered: Unfreezing averaging operations")
        unfreeze_all_averaging()
        averaging_frozen = False

    # 3. –û–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ)
    if not averaging_frozen:
        for strategy in self.strategies:
            for side in ['Buy', 'Sell']:
                if strategy.should_execute_averaging(side, current_price):
                    strategy.execute_averaging_with_reserve_check(side, current_price)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤—Ö–æ–¥ –≤ –ø–∞–Ω–∏–∫—É (–ø–∞–Ω–∏–∫–∞ = –±–æ–ª–µ–µ —Å–µ—Ä—å–µ–∑–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑–µ—Ä–≤ intact (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏)
- ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç TP —Ä–∞–±–æ—Ç–∞—Ç—å (–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ IM —á–µ—Ä–µ–∑ natural exits)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ unfreezing –∫–æ–≥–¥–∞ IM –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
- ‚úÖ –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç tier upgrades (–∑–∞–ø–∞—Å 1.5√ó –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ä–æ—Å—Ç IM)

**–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Early Freeze –∏ Panic Mode:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Early Freeze | Panic Mode |
|----------|-------------|------------|
| **–¢—Ä–∏–≥–≥–µ—Ä** | available < next_avg √ó 1.5 | available < next_avg √ó 3 –ò–õ–ò imbalance+low_IM |
| **–î–µ–π—Å—Ç–≤–∏—è** | Freeze —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π | Freeze + Cancel TP + Balance positions |
| **TP —Ä–∞–±–æ—Ç–∞–µ—Ç?** | ‚úÖ –î–ê (–Ω–∞ –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω–∞—Ö) | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ (trend side removed) |
| **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞?** | ‚ùå –ù–ï–¢ (–∂–¥–µ–º TP) | ‚úÖ –î–ê (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤) |
| **–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å** | üü° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è |
| **–†–µ–∑–µ—Ä–≤** | üîí –ù–µ —Ç—Ä–æ–≥–∞–µ–º | üîì –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ |

**–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:**

```python
# –°—Ü–µ–Ω–∞—Ä–∏–π: available_for_trading —Å–Ω–∏–∂–∞–µ—Ç—Å—è

# –®–∞–≥ 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
available = $500
next_worst_case = $200
comfort_threshold = $300
$500 > $300 ‚úÖ ‚Üí –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã

# –®–∞–≥ 2: IM —Å–Ω–∏–∑–∏–ª—Å—è –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π
available = $280
next_worst_case = $220
comfort_threshold = $330
$280 < $330 ‚úÖ ‚Üí EARLY FREEZE! –ë–ª–æ–∫–∏—Ä—É–µ–º —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è

# –®–∞–≥ 3: LONG –∑–∞–∫—Ä—ã–ª—Å—è –ø–æ TP
# –û—Å–≤–æ–±–æ–¥–∏–ª $50 IM
available = $330
comfort_threshold = $330
$330 >= $330 ‚úÖ ‚Üí UNFREEZE! –†–∞–∑—Ä–µ—à–∞–µ–º —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è —Å–Ω–æ–≤–∞

# –ü–∞–Ω–∏–∫–∞ –ù–ï –ê–ö–¢–ò–í–ò–†–û–í–ê–õ–ê–°–¨! Early freeze –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–∏—Ç—É–∞—Ü–∏—é ‚úÖ
```

**–í—ã–≤–æ–¥:** Early Freeze - —ç—Ç–æ –ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è –∑–∞—â–∏—Ç—ã, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—â–∞—è –ø–∞–Ω–∏–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—â–∞—è —Ä–µ–∑–µ—Ä–≤ intact.

---

## 4. –†–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)

### 4.1 –¢—Ä–∏–≥–≥–µ—Ä—ã –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–∏–∫—É

#### –¢—Ä–∏–≥–≥–µ—Ä 1: –ù–∏–∑–∫–∏–π Available IM (–û–°–ù–û–í–ù–û–ô)

```python
def check_panic_trigger_low_im() -> (bool, str):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ IM –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã

    Returns:
        (triggered, reason)
    """
    # –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
    im_metrics = monitor_initial_margin()
    available_for_trading = im_metrics['available_for_trading']

    # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ (worst case - –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã)
    next_long_margin = calculate_next_averaging_margin('Buy')
    next_short_margin = calculate_next_averaging_margin('Sell')
    next_averaging_worst_case = next_long_margin + next_short_margin

    # –ü–æ—Ä–æ–≥ –ø–∞–Ω–∏–∫–∏: available < next_averaging √ó comfort_factor
    comfort_factor = 3  # –ó–∞–ø–∞—Å –Ω–∞ 3 —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    panic_threshold = next_averaging_worst_case * comfort_factor

    if available_for_trading < panic_threshold:
        reason = (
            f"LOW_IM: available=${available_for_trading:.2f} < "
            f"threshold=${panic_threshold:.2f} (next_avg={next_averaging_worst_case:.2f} √ó {comfort_factor})"
        )
        return (True, reason)

    return (False, "")


# –ü—Ä–∏–º–µ—Ä:
# –ë–∞–ª–∞–Ω—Å: $10,000
# Used IM: $6,000
# Safety reserve: $3,840
# Available: $10,000 - $6,000 - $3,840 = $160
#
# Next LONG averaging: $32
# Next SHORT averaging: $16
# Next worst case: $48
# Panic threshold: $48 √ó 3 = $144
#
# $160 > $144 ‚Üí –ù–ï –ø–∞–Ω–∏–∫–∞ ‚úÖ
#
# –ù–æ –µ—Å–ª–∏ available = $130:
# $130 < $144 ‚Üí –ü–ê–ù–ò–ö–ê! ‚ùå
```

#### –¢—Ä–∏–≥–≥–µ—Ä 2: –î–∏—Å–±–∞–ª–∞–Ω—Å + –ù–∏–∑–∫–∏–π IM

```python
def check_panic_trigger_imbalance_low_im() -> (bool, str):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞: –±–æ–ª—å—à–æ–π –¥–∏—Å–±–∞–ª–∞–Ω—Å –ø—Ä–∏ –Ω–∏–∑–∫–æ–º IM
    """
    # –ü–æ–ª—É—á–∏—Ç—å —É—Ä–æ–≤–Ω–∏
    long_level = position_manager.get_grid_level('Buy')
    short_level = position_manager.get_grid_level('Sell')
    level_diff = abs(long_level - short_level)

    # –ü–æ–ª—É—á–∏—Ç—å available IM
    im_metrics = monitor_initial_margin()
    available_percent = im_metrics['available_percent']

    # –ü—Ä–æ–≤–µ—Ä–∫–∞
    if level_diff >= 5 and available_percent < 30:
        reason = (
            f"IMBALANCE_LOW_IM: level_diff={level_diff} (>= 5), "
            f"available_IM={available_percent:.1f}% (< 30%)"
        )
        return (True, reason)

    return (False, "")
```

#### –¢—Ä–∏–≥–≥–µ—Ä 3: High MM Rate (–∞–≤–∞—Ä–∏–π–Ω—ã–π)

```python
def check_panic_trigger_high_mm_rate() -> (bool, str):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞: Account MM Rate —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π
    """
    im_metrics = monitor_initial_margin()
    account_mm_rate = im_metrics['account_mm_rate'] * 100  # –í –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö

    mm_rate_panic_threshold = 70.0  # 70%

    if account_mm_rate >= mm_rate_panic_threshold:
        reason = f"HIGH_MM_RATE: {account_mm_rate:.2f}% >= {mm_rate_panic_threshold}%"
        return (True, reason)

    return (False, "")
```

#### –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

```python
def check_all_panic_triggers() -> (bool, str):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –ø–∞–Ω–∏–∫–∏

    Returns:
        (panic_triggered, reason)
    """
    # –¢—Ä–∏–≥–≥–µ—Ä 1: –ù–∏–∑–∫–∏–π IM
    triggered, reason = check_panic_trigger_low_im()
    if triggered:
        return (True, reason)

    # –¢—Ä–∏–≥–≥–µ—Ä 2: –î–∏—Å–±–∞–ª–∞–Ω—Å + –ù–∏–∑–∫–∏–π IM
    triggered, reason = check_panic_trigger_imbalance_low_im()
    if triggered:
        return (True, reason)

    # –¢—Ä–∏–≥–≥–µ—Ä 3: High MM Rate
    triggered, reason = check_panic_trigger_high_mm_rate()
    if triggered:
        return (True, reason)

    return (False, "")
```

### 4.2 –î–µ–π—Å—Ç–≤–∏—è –≤ —Ä–µ–∂–∏–º–µ –ø–∞–Ω–∏–∫–∏

#### –≠—Ç–∞–ø 1: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π

```python
def enter_panic_mode(reason: str):
    """
    –í–æ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏

    Args:
        reason: –ü—Ä–∏—á–∏–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–∞–Ω–∏–∫–∏
    """
    global panic_mode_active
    panic_mode_active = True

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    logger.error(f"üö® PANIC MODE ACTIVATED: {reason}")

    # 1. –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    block_all_averaging()
    logger.info("All averaging operations BLOCKED")

    # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ...
```

#### –≠—Ç–∞–ø 2: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TP

**–°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è):**
- –°–Ω—è—Ç—å TP —É "—É–±—ã—Ç–æ—á–Ω–æ–π" —Å—Ç–æ—Ä–æ–Ω—ã (–∫–æ—Ç–æ—Ä–∞—è —É—Å—Ä–µ–¥–Ω—è–ª–∞—Å—å –±–æ–ª—å—à–µ)
- –û—Å—Ç–∞–≤–∏—Ç—å TP —É "–ø—Ä–æ—Ñ–∏—Ç–Ω–æ–π"

**–ü—Ä–æ–±–ª–µ–º–∞:**
–£–±—ã—Ç–æ—á–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ = —Å—Ç–æ—Ä–æ–Ω–∞ –ü–†–û–¢–ò–í —Ç—Ä–µ–Ω–¥–∞. –ï—Å–ª–∏ —Ç—Ä–µ–Ω–¥ —Ä–∞–∑–≤–µ—Ä–Ω–µ—Ç—Å—è, –∏–º–µ–Ω–Ω–æ –æ–Ω–∞ —Å—Ç–∞–Ω–µ—Ç –ø—Ä–æ—Ñ–∏—Ç–Ω–æ–π –ø–µ—Ä–≤–æ–π!

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è):**
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–†–ï–ù–î–ê (–ø–æ –¥–∏—Å–±–∞–ª–∞–Ω—Å—É —É—Ä–æ–≤–Ω–µ–π)
- –°–Ω—è—Ç—å TP —É —Å—Ç–æ—Ä–æ–Ω—ã –¢–†–ï–ù–î–ê (–ø—É—Å—Ç—å –¥–∞–ª—å—à–µ —Ä–∞—Å—Ç–µ—Ç, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å —Ä–∞–Ω–æ)
- –û—Å—Ç–∞–≤–∏—Ç—å TP —É COUNTER-TREND —Å—Ç–æ—Ä–æ–Ω—ã (–∑–∞–∫—Ä—ã—Ç—å –Ω–∞ –æ—Ç–∫–∞—Ç–µ = natural exit)

```python
def cancel_tp_intelligently():
    """
    –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TP –≤ –ø–∞–Ω–∏–∫–µ

    –¶–µ–ª—å: –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —à–∞–Ω—Å—ã –Ω–∞ natural exit (TP –Ω–∞ –æ—Ç–∫–∞—Ç–µ)
    """
    # 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞ –ø–æ grid levels
    long_level = position_manager.get_grid_level('Buy')
    short_level = position_manager.get_grid_level('Sell')

    if short_level > long_level:
        # SHORT —É—Å—Ä–µ–¥–Ω—è–ª—Å—è –±–æ–ª—å—à–µ ‚Üí downtrend (—Ü–µ–Ω–∞ –ø–∞–¥–∞–ª–∞)
        trend_side = 'Sell'
        counter_trend_side = 'Buy'
        trend_direction = "DOWN"
    else:
        # LONG —É—Å—Ä–µ–¥–Ω—è–ª—Å—è –±–æ–ª—å—à–µ ‚Üí uptrend (—Ü–µ–Ω–∞ —Ä–æ—Å–ª–∞)
        trend_side = 'Buy'
        counter_trend_side = 'Sell'
        trend_direction = "UP"

    logger.info(
        f"Detected trend: {trend_direction} "
        f"(trend_side={trend_side} level={short_level if trend_side=='Sell' else long_level}, "
        f"counter={counter_trend_side} level={long_level if trend_side=='Buy' else short_level})"
    )

    # 2. –°–Ω—è—Ç—å TP —É TREND side
    # –õ–æ–≥–∏–∫–∞: –ï—Å–ª–∏ —Ç—Ä–µ–Ω–¥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è, –ø–æ–∑–∏—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —É—Å—Ä–µ–¥–Ω—è—Ç—å—Å—è
    # –ù–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Ä–∞–Ω–æ, –ø—É—Å—Ç—å –¥–∞–ª—å—à–µ –∏–¥–µ—Ç
    trend_tp_id = position_manager.get_tp_order_id(trend_side)
    if trend_tp_id:
        if not dry_run:
            bybit_client.cancel_order(symbol, trend_tp_id)
        logger.info(f"‚úÖ Removed TP on TREND side ({trend_side}): allow further growth")

    # 3. –û–°–¢–ê–í–ò–¢–¨ TP —É COUNTER-TREND side
    # –õ–æ–≥–∏–∫–∞: –ï—Å–ª–∏ –±—É–¥–µ—Ç –æ—Ç–∫–∞—Ç (reversal), —ç—Ç–∞ —Å—Ç–æ—Ä–æ–Ω–∞ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π
    # –≠—Ç–æ NATURAL EXIT –∏–∑ –ø–∞–Ω–∏–∫–∏!
    counter_tp_id = position_manager.get_tp_order_id(counter_trend_side)
    if counter_tp_id:
        logger.info(
            f"‚úÖ KEEPING TP on COUNTER-TREND side ({counter_trend_side}): "
            f"waiting for reversal (natural exit)"
        )

    # 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    logger.info(
        f"TP Strategy: "
        f"If trend reverses ‚Üí {counter_trend_side} hits TP ‚Üí natural exit ‚úÖ | "
        f"If trend continues ‚Üí wait for stabilization, controlled exit"
    )
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ:**

```python
# –°—Ü–µ–Ω–∞—Ä–∏–π: Uptrend (+10%)
# LONG: level=0, SHORT: level=8 (—É—Å—Ä–µ–¥–Ω—è–ª—Å—è –º–Ω–æ–≥–æ)

# –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞:
# - –°–Ω—è—Ç—å TP SHORT (—É–±—ã—Ç–æ—á–Ω–∞—è)
# - –û—Å—Ç–∞–≤–∏—Ç—å TP LONG (–ø—Ä–æ—Ñ–∏—Ç–Ω–∞—è)
# –ü—Ä–æ–±–ª–µ–º–∞: –ï—Å–ª–∏ –æ—Ç–∫–∞—Ç -1%, LONG –∑–∞–∫—Ä–æ–µ—Ç—Å—è, SHORT –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≥–æ–ª—ã–º!

# –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:
# - Trend = uptrend (–ø–æ SHORT averaging)
# - –°–Ω—è—Ç—å TP LONG (trend side, –ø—É—Å—Ç—å —Ä–∞—Å—Ç–µ—Ç)
# - –û—Å—Ç–∞–≤–∏—Ç—å TP SHORT (counter-trend)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –ï—Å–ª–∏ –æ—Ç–∫–∞—Ç -1% ‚Üí SHORT –∑–∞–∫—Ä–æ–µ—Ç—Å—è (natural exit!) ‚úÖ
#            –ï—Å–ª–∏ —Ç—Ä–µ–Ω–¥ +1% ‚Üí LONG –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç, SHORT —Ç–æ–∂–µ (—Å–∏–º–º–µ—Ç—Ä–∏—è)
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å natural exit:**

```python
def on_tp_closed_during_panic(closed_side: str, close_price: float):
    """
    Natural exit: Counter-trend —Å—Ç–æ—Ä–æ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ TP
    """
    logger.info(
        f"üü¢ NATURAL EXIT: {closed_side} hit TP @ ${close_price:.4f} during panic. "
        f"This is the COUNTER-TREND side - market reversed!"
    )

    # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–π—Ç–∏ –∏–∑ –ø–∞–Ω–∏–∫–∏
    exit_panic_mode("NATURAL_EXIT_COUNTER_TREND_TP")

    # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã—Ö–æ–¥ (adaptive reopen, restore TP)
```

#### –≠—Ç–∞–ø 3: –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ)

```python
# –í TradingAccount (–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –í–°–ï–• —Å–∏–º–≤–æ–ª–æ–≤!)
def balance_all_positions_adaptive(self):
    """
    –í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –¥–ª—è –í–°–ï–• —Å–∏–º–≤–æ–ª–æ–≤ –∞–∫–∫–∞—É–Ω—Ç–∞

    –¶–µ–ª—å: LONG_qty = SHORT_qty (–≤ –º–æ–Ω–µ—Ç–∞—Ö!) –¥–ª—è –ö–ê–ñ–î–û–ì–û —Å–∏–º–≤–æ–ª–∞

    –í–∞—Ä–∏–∞–Ω—Ç—ã:
    A) –ü–æ–ª–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (100%) - –µ—Å–ª–∏ IM –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω
    B) –ß–∞—Å—Ç–∏—á–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ - –µ—Å–ª–∏ IM –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
    C) –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ - –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –í–°–Å)
    """
    # 1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
    total_balance = self.balance_manager.get_available_balance()
    total_im = self.balance_manager.get_initial_margin()

    # 2. –°–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞—Ö –í–°–ï–• —Å–∏–º–≤–æ–ª–æ–≤
    symbols_to_balance = []

    for strategy in self.strategies:
        symbol = strategy.symbol

        # –†–∞–∑–º–µ—Ä—ã –ø–æ–∑–∏—Ü–∏–π –≤ –ú–û–ù–ï–¢–ê–•
        long_qty = strategy.position_manager.get_total_quantity('Buy')
        short_qty = strategy.position_manager.get_total_quantity('Sell')

        # –î–∏—Å–±–∞–ª–∞–Ω—Å –≤ –ú–û–ù–ï–¢–ê–•
        imbalance_qty = abs(long_qty - short_qty)

        if imbalance_qty > 0:
            # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Ç—Å—Ç–∞—é—â—É—é —Å—Ç–æ—Ä–æ–Ω—É
            if long_qty < short_qty:
                lagging_side = 'Buy'
                qty_to_buy = short_qty - long_qty
            else:
                lagging_side = 'Sell'
                qty_to_buy = long_qty - short_qty

            # –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
            current_price = strategy.get_current_price()

            # –ú–∞—Ä–∂–∞ –Ω—É–∂–Ω–∞—è –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
            margin_needed = (qty_to_buy * current_price) / strategy.leverage

            symbols_to_balance.append({
                'strategy': strategy,
                'symbol': symbol,
                'lagging_side': lagging_side,
                'qty_to_buy': qty_to_buy,
                'current_price': current_price,
                'margin_needed': margin_needed
            })

    if not symbols_to_balance:
        self.logger.info("All symbols are balanced, no action needed")
        return

    # 3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–±—â—É—é –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –º–∞—Ä–∂–µ –¥–ª—è –ø–æ–ª–Ω–æ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
    total_margin_needed = sum(item['margin_needed'] for item in symbols_to_balance)

    # 4. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (–ë–ï–ó —Ä–µ–∑–µ—Ä–≤–∞ - –≤ –ø–∞–Ω–∏–∫–µ —Ä–µ–∑–µ—Ä–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è!)
    available = total_balance - total_im

    # 5. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
    if available >= total_margin_needed:
        # –í–∞—Ä–∏–∞–Ω—Ç A: –ü–æ–ª–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤ (100%)
        balance_percentage = 100
        self.logger.info(
            f"Full balancing possible: ${total_margin_needed:.2f} needed, "
            f"${available:.2f} available ({len(symbols_to_balance)} symbols)"
        )

        # –ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –Ω–∞ 100%
        for item in symbols_to_balance:
            self._execute_balancing(
                strategy=item['strategy'],
                side=item['lagging_side'],
                qty=item['qty_to_buy'],
                price=item['current_price']
            )

    elif available > 0:
        # –í–∞—Ä–∏–∞–Ω—Ç B: –ß–∞—Å—Ç–∏—á–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        balance_percentage = (available / total_margin_needed) * 100
        self.logger.warning(
            f"Partial balancing: ${available:.2f} available, ${total_margin_needed:.2f} needed "
            f"({balance_percentage:.1f}% of needed, {len(symbols_to_balance)} symbols)"
        )

        # –ë–∞–ª–∞–Ω—Å–∏—Ä—É–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
        for item in symbols_to_balance:
            qty_partial = item['qty_to_buy'] * (available / total_margin_needed)
            self._execute_balancing(
                strategy=item['strategy'],
                side=item['lagging_side'],
                qty=qty_partial,
                price=item['current_price']
            )

    else:
        # –í–∞—Ä–∏–∞–Ω—Ç C: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è - –¥–∞–∂–µ 1 —Ü–µ–Ω—Ç–∞ –Ω–µ—Ç
        self.logger.critical(
            f"CATASTROPHIC: No funds available for balancing! "
            f"Positions CANNOT be balanced. Waiting for market reversal. "
            f"({len(symbols_to_balance)} symbols need balancing)"
        )
        return


def _execute_balancing(self, strategy, side: str, qty: float, price: float):
    """
    –í—ã–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞

    Args:
        strategy: GridStrategy instance
        side: 'Buy' or 'Sell'
        qty: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
        price: –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
    """
    symbol = strategy.symbol

    if not strategy.dry_run:
        strategy.client.place_order(
            symbol=symbol,
            side=side,
            qty=qty,
            order_type='Market'
        )

    # –û–±–Ω–æ–≤–∏—Ç—å position manager
    strategy.position_manager.add_position(
        side=side,
        entry_price=price,
        quantity=qty,
        grid_level=strategy.position_manager.get_grid_level(side)  # –£—Ä–æ–≤–µ–Ω—å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
    )

    margin_used = (qty * price) / strategy.leverage

    self.logger.info(
        f"[{symbol}] Balanced {side}: added {qty:.4f} coins @ ${price:.4f} "
        f"(${margin_used:.2f} margin)"
    )
```

**–ü—Ä–∏–º–µ—Ä (–º—É–ª—å—Ç–∏—Å–∏–º–≤–æ–ª—å–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞):**

```python
# Account 1: DOGEUSDT + TONUSDT
# –ë–∞–ª–∞–Ω—Å: $10,000, Used IM: $3,000, Available: $7,000

# –î–∏—Å–±–∞–ª–∞–Ω—Å—ã:
# DOGEUSDT: LONG 100, SHORT 500 ‚Üí –Ω—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å 400 DOGE
#   400 DOGE √ó $0.15 / 75 = $0.80 –º–∞—Ä–∂–∏
#
# TONUSDT: LONG 10, SHORT 50 ‚Üí –Ω—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å 40 TON
#   40 TON √ó $5.00 / 50 = $4.00 –º–∞—Ä–∂–∏
#
# –í—Å–µ–≥–æ –Ω—É–∂–Ω–æ: $0.80 + $4.00 = $4.80

# CHECK: $7,000 >= $4.80 ‚úÖ ‚Üí –ü–æ–ª–Ω–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ (100%)

# –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏:
# DOGEUSDT: LONG 500, SHORT 500 ‚úÖ BALANCED
# TONUSDT: LONG 50, SHORT 50 ‚úÖ BALANCED
```

#### –≠—Ç–∞–ø 4: –ü–µ—Ä–µ—Ö–æ–¥ –≤ –æ–∂–∏–¥–∞–Ω–∏–µ

```python
def enter_waiting_for_stabilization():
    """
    –ü–µ—Ä–µ–π—Ç–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏"
    """
    global panic_state
    panic_state = 'WAITING_STABILIZATION'

    logger.info(
        "Entering WAITING_FOR_STABILIZATION state. "
        "Monitoring: ATR, MM Rate, IM recovery, PnL"
    )

    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥)
    # –≠—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ
```

### 4.3 –¢—Ä–∏–≥–≥–µ—Ä—ã –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–∞–Ω–∏–∫–∏

#### –¢—Ä–∏–≥–≥–µ—Ä 1: –ü—Ä–æ—Ñ–∏—Ç–Ω–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ TP (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π)

```python
def check_exit_trigger_profitable_hit_tp() -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞: –∑–∞–∫—Ä—ã–ª–∞—Å—å –ª–∏ –ø—Ä–æ—Ñ–∏—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –ø–æ TP

    –≠—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ - –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è IM, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å—Å—è
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ TP —Å–æ–±—ã—Ç–∏—è
    # –ï—Å–ª–∏ –≤ –ø–∞–Ω–∏–∫–µ –ò —Å—Ç–æ—Ä–æ–Ω–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ TP ‚Üí –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥
    return False  # Placeholder, —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ TP


def on_tp_closed_during_panic(closed_side: str, close_price: float):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ TP –≤–æ –≤—Ä–µ–º—è –ø–∞–Ω–∏–∫–∏ - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥
    """
    logger.info(f"TP closed during panic: {closed_side} @ ${close_price:.4f}")

    # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–π—Ç–∏ –∏–∑ –ø–∞–Ω–∏–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
    exit_panic_mode(reason="PROFITABLE_TP_HIT")

    # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—ã—Ö–æ–¥–∞
    process_panic_exit()
```

#### –¢—Ä–∏–≥–≥–µ—Ä 2: IM –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è + –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —É–ø–∞–ª–∞

```python
def check_exit_trigger_im_and_volatility() -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ª–∏ IM –∏ —É–ø–∞–ª–∞ –ª–∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å

    –í–°–ï —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
    1. Available IM > next_averaging √ó 5 (—Ö–æ—Ä–æ—à–∏–π –∑–∞–ø–∞—Å)
    2. ATR < 1.5% (–Ω–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)
    3. ATR —Å—Ç–∞–±–∏–ª–µ–Ω –º–∏–Ω–∏–º—É–º 30 –º–∏–Ω—É—Ç
    4. MM Rate < 40% (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞)
    """
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ IM
    im_metrics = monitor_initial_margin()
    available_for_trading = im_metrics['available_for_trading']

    next_long_margin = calculate_next_averaging_margin('Buy')
    next_short_margin = calculate_next_averaging_margin('Sell')
    next_averaging_worst_case = next_long_margin + next_short_margin

    im_threshold = next_averaging_worst_case * 5
    im_recovered = available_for_trading > im_threshold

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
    atr = calculate_atr(period=14)  # 14-period ATR
    current_price = get_current_price()
    atr_percent = (atr / current_price) * 100

    volatility_low = atr_percent < 1.5

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ ATR (30 –º–∏–Ω—É—Ç)
    atr_stable = check_atr_stability(threshold=1.5, duration_minutes=30)

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ MM Rate
    account_mm_rate = im_metrics['account_mm_rate'] * 100
    mm_rate_safe = account_mm_rate < 40.0

    # –í–°–ï —É—Å–ª–æ–≤–∏—è
    all_conditions_met = im_recovered and volatility_low and atr_stable and mm_rate_safe

    if all_conditions_met:
        logger.info(
            f"Exit trigger MET: IM_recovered={im_recovered} (${available_for_trading:.2f} > ${im_threshold:.2f}), "
            f"volatility_low={volatility_low} (ATR={atr_percent:.2f}%), "
            f"atr_stable={atr_stable}, MM_rate_safe={mm_rate_safe} ({account_mm_rate:.2f}%)"
        )
        return True
    else:
        logger.debug(
            f"Exit conditions NOT met: IM={im_recovered}, vol={volatility_low}, "
            f"stable={atr_stable}, MM={mm_rate_safe}"
        )
        return False


def calculate_atr(period: int = 14) -> float:
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å ATR (Average True Range) - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏

    Args:
        period: –ü–µ—Ä–∏–æ–¥ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ (–æ–±—ã—á–Ω–æ 14)

    Returns:
        atr: –°—Ä–µ–¥–Ω–∏–π True Range
    """
    # –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (kline)
    klines = bybit_client.get_kline(
        symbol=symbol,
        interval='1',  # 1 –º–∏–Ω—É—Ç–∞
        limit=period + 1
    )

    # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å True Range –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞—Ä–∞
    true_ranges = []
    for i in range(1, len(klines)):
        high = float(klines[i]['high'])
        low = float(klines[i]['low'])
        prev_close = float(klines[i-1]['close'])

        tr = max(
            high - low,
            abs(high - prev_close),
            abs(low - prev_close)
        )
        true_ranges.append(tr)

    # ATR = —Å—Ä–µ–¥–Ω–∏–π TR
    atr = sum(true_ranges) / len(true_ranges)
    return atr


def check_atr_stability(threshold: float, duration_minutes: int) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ATR (–≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è < threshold –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–∏–Ω—É—Ç)

    Args:
        threshold: –ü–æ—Ä–æ–≥ ATR –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.5%)
        duration_minutes: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30 –º–∏–Ω—É—Ç)

    Returns:
        True –µ—Å–ª–∏ ATR –±—ã–ª —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∏–∑–∫–∏–º
    """
    # –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ATR –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–∏–Ω—É—Ç
    # (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ATR –≤ –ø–∞–º—è—Ç–∏)

    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å ATR –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–∏–Ω—É—Ç
    num_checks = duration_minutes // 5  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

    for i in range(num_checks):
        # –ü–æ–ª—É—á–∏—Ç—å kline –∑–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–µ—Ä–∏–æ–¥
        offset_minutes = i * 5
        klines = bybit_client.get_kline(
            symbol=symbol,
            interval='1',
            limit=15,  # 14 + 1 –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ ATR
            # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å endTime –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        )

        # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å ATR –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        atr = calculate_atr_from_klines(klines)
        current_price = float(klines[-1]['close'])
        atr_percent = (atr / current_price) * 100

        if atr_percent >= threshold:
            # ATR –±—ã–ª –≤—ã—Å–æ–∫–∏–º –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥
            return False

    # –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏
    return True
```

#### –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã—Ö–æ–¥–∞

```python
def check_panic_exit_triggers() -> (bool, str):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–∞–Ω–∏–∫–∏

    Returns:
        (should_exit, reason)
    """
    # –¢—Ä–∏–≥–≥–µ—Ä 1: –ü—Ä–æ—Ñ–∏—Ç–Ω–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ TP
    # (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ TP)

    # –¢—Ä–∏–≥–≥–µ—Ä 2: IM + –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
    if check_exit_trigger_im_and_volatility():
        return (True, "IM_AND_VOLATILITY_RECOVERED")

    return (False, "")
```

### 4.4 –ü—Ä–æ—Ü–µ—Å—Å –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–∞–Ω–∏–∫–∏

```python
def exit_panic_mode(reason: str):
    """
    –í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –ø–∞–Ω–∏–∫–∏

    Args:
        reason: –ü—Ä–∏—á–∏–Ω–∞ –≤—ã—Ö–æ–¥–∞
    """
    global panic_mode_active, panic_state

    logger.info(f"üü¢ EXITING PANIC MODE: {reason}")

    # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã—Ö–æ–¥
    process_panic_exit()

    # –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥–∏
    panic_mode_active = False
    panic_state = None

    logger.info("Panic mode DEACTIVATED. Returning to normal operation.")


def process_panic_exit():
    """
    –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–∞–Ω–∏–∫–∏
    """
    # –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±–æ–ª–µ–µ –ø—Ä–∏–±—ã–ª—å–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
    long_pnl = position_manager.calculate_pnl(get_current_price(), 'Buy')
    short_pnl = position_manager.calculate_pnl(get_current_price(), 'Sell')

    if long_pnl > abs(short_pnl):
        profitable_side = 'Buy'
        losing_side = 'Sell'
    else:
        profitable_side = 'Sell'
        losing_side = 'Buy'

    logger.info(
        f"Profitable side: {profitable_side} (PnL=${long_pnl if profitable_side=='Buy' else short_pnl:.2f}), "
        f"Losing side: {losing_side}"
    )

    # –®–∞–≥ 2: –ó–∞–∫—Ä—ã—Ç—å –±–æ–ª–µ–µ –ø—Ä–∏–±—ã–ª—å–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
    close_side_completely(profitable_side)

    # –®–∞–≥ 3: –û—Ü–µ–Ω–∏—Ç—å –Ω—É–∂–Ω–æ –ª–∏ —É—Å—Ä–µ–¥–Ω–∏—Ç—å —É–±—ã—Ç–æ—á–Ω—É—é
    should_average_losing = evaluate_averaging_losing_side(losing_side)

    if should_average_losing:
        # –£—Å—Ä–µ–¥–Ω–∏—Ç—å 1 —Ä–∞–∑ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–µ–∑–µ—Ä–≤–∞!)
        execute_panic_exit_averaging(losing_side)

    # –®–∞–≥ 4: –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –∑–∞–∫—Ä—ã—Ç—É—é (–ø—Ä–æ—Ñ–∏—Ç–Ω—É—é) –∞–¥–∞–ø—Ç–∏–≤–Ω–æ
    reopen_after_panic_exit(profitable_side, losing_side)

    # –®–∞–≥ 5: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TP –æ—Ä–¥–µ—Ä–∞
    restore_tp_orders()

    # –®–∞–≥ 6: –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    unblock_all_averaging()

    logger.info("Panic exit completed successfully")


def close_side_completely(side: str):
    """
    –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª–Ω–æ—Å—Ç—å—é
    """
    total_qty = position_manager.get_total_quantity(side)
    current_price = get_current_price()

    if total_qty > 0:
        if not dry_run:
            bybit_client.place_order(
                symbol=symbol,
                side='Sell' if side == 'Buy' else 'Buy',  # –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
                qty=total_qty,
                order_type='Market'
            )

        # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å PnL
        pnl = position_manager.calculate_pnl(current_price, side)

        # –û–±–Ω–æ–≤–∏—Ç—å position manager
        position_manager.remove_all_positions(side)

        logger.info(f"Closed {side} completely: qty={total_qty:.6f}, PnL=${pnl:.2f}")


def evaluate_averaging_losing_side(losing_side: str) -> bool:
    """
    –û—Ü–µ–Ω–∏—Ç—å –Ω—É–∂–Ω–æ –ª–∏ —É—Å—Ä–µ–¥–Ω–∏—Ç—å —É–±—ã—Ç–æ—á–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É

    –ö—Ä–∏—Ç–µ—Ä–∏–∏:
    1. –£–±—ã—Ç–æ–∫ > 2% –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
    2. –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å <= 4 (–Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–æ–ª—å—à–æ–π –¥–∏—Å–±–∞–ª–∞–Ω—Å)
    3. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∑–µ—Ä–≤–∞
    """
    avg_entry = position_manager.get_average_entry_price(losing_side)
    current_price = get_current_price()

    # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —É–±—ã—Ç–æ–∫ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
    if losing_side == 'Buy':
        loss_percent = ((avg_entry - current_price) / avg_entry) * 100
    else:
        loss_percent = ((current_price - avg_entry) / avg_entry) * 100

    # –ö—Ä–∏—Ç–µ—Ä–∏–π 1: —É–±—ã—Ç–æ–∫ > 2%
    if loss_percent <= 2.0:
        logger.info(f"Skip averaging {losing_side}: loss={loss_percent:.2f}% <= 2%")
        return False

    # –ö—Ä–∏—Ç–µ—Ä–∏–π 2: –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å <= 4
    current_level = position_manager.get_grid_level(losing_side)
    new_level = current_level + 1

    if new_level > 4:
        logger.info(f"Skip averaging {losing_side}: new_level={new_level} > 4")
        return False

    # –ö—Ä–∏—Ç–µ—Ä–∏–π 3: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∑–µ—Ä–≤–∞
    next_margin = calculate_next_averaging_margin(losing_side)
    safety_reserve = calculate_safety_reserve(symbol, max_grid_levels, multiplier, leverage, current_price)

    if not check_reserve_before_averaging(losing_side, next_margin, safety_reserve):
        logger.info(f"Skip averaging {losing_side}: insufficient reserve")
        return False

    # –í—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
    logger.info(
        f"Will average {losing_side}: loss={loss_percent:.2f}%, "
        f"new_level={new_level}, reserve OK"
    )
    return True


def execute_panic_exit_averaging(losing_side: str):
    """
    –í—ã–ø–æ–ª–Ω–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —É–±—ã—Ç–æ—á–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –ø–∞–Ω–∏–∫–∏
    """
    current_price = get_current_price()
    next_margin = calculate_next_averaging_margin(losing_side)
    next_qty = margin_to_qty(next_margin, current_price, leverage)
    current_level = position_manager.get_grid_level(losing_side)

    if not dry_run:
        bybit_client.place_order(
            symbol=symbol,
            side=losing_side,
            qty=next_qty,
            order_type='Market'
        )

    # –û–±–Ω–æ–≤–∏—Ç—å position manager
    position_manager.add_position(
        side=losing_side,
        entry_price=current_price,
        quantity=next_qty,
        grid_level=current_level + 1
    )

    logger.info(
        f"Panic exit averaging: {losing_side} level {current_level} ‚Üí {current_level + 1}, "
        f"margin=${next_margin:.2f}"
    )


def reopen_after_panic_exit(closed_side: str, opposite_side: str):
    """
    –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å –∑–∞–∫—Ä—ã—Ç—É—é —Å—Ç–æ—Ä–æ–Ω—É –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–∞–Ω–∏–∫–∏
    """
    # –ü–æ–ª—É—á–∏—Ç—å —É—Ä–æ–≤–Ω–∏
    closed_level = 0  # –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
    opposite_level = position_manager.get_grid_level(opposite_side)
    level_diff = abs(opposite_level - closed_level)

    # –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞ —á—Ç–æ –≤ —Ä–∞–∑–¥–µ–ª–µ 2)
    opposite_margin = position_manager.get_total_margin(opposite_side)

    if level_diff >= 4:
        reopen_margin = opposite_margin  # 100%
    elif level_diff == 3:
        reopen_margin = opposite_margin * 0.5  # 50%
    elif level_diff == 2:
        reopen_margin = opposite_margin * 0.25  # 25%
    else:
        reopen_margin = initial_position_size_usd  # –ù–∞—á–∞–ª—å–Ω—ã–π

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–∞
    safety_reserve = calculate_safety_reserve(symbol, max_grid_levels, multiplier, leverage, get_current_price())

    if not check_reserve_before_averaging(closed_side, reopen_margin, safety_reserve):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        im_metrics = monitor_initial_margin()
        max_reopen = im_metrics['available_for_trading'] - safety_reserve
        reopen_margin = max(max_reopen, 0)
        logger.warning(f"Reopening with reduced size: ${reopen_margin:.2f}")

    if reopen_margin > 0:
        current_price = get_current_price()
        reopen_qty = margin_to_qty(reopen_margin, current_price, leverage)

        if not dry_run:
            bybit_client.place_order(
                symbol=symbol,
                side=closed_side,
                qty=reopen_qty,
                order_type='Market'
            )

        # –û–±–Ω–æ–≤–∏—Ç—å position manager
        new_level = opposite_level if level_diff >= 4 else 0
        position_manager.add_position(
            side=closed_side,
            entry_price=current_price,
            quantity=reopen_qty,
            grid_level=new_level
        )

        logger.info(
            f"Reopened {closed_side} after panic exit: margin=${reopen_margin:.2f}, "
            f"level={new_level}"
        )


def restore_tp_orders():
    """
    –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TP –æ—Ä–¥–µ—Ä–∞ –¥–ª—è –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω
    """
    for side in ['Buy', 'Sell']:
        if position_manager.get_total_quantity(side) > 0:
            update_tp_order(side)

    logger.info("TP orders restored for both sides")


def unblock_all_averaging():
    """
    –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    """
    global averaging_blocked
    averaging_blocked = False
    logger.info("Averaging operations UNBLOCKED")
```

---

## 5. –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

### 5.1 –°—Ü–µ–Ω–∞—Ä–∏–π A: –¢—Ä–µ–Ω–¥ –≤–≤–µ—Ä—Ö +10% –±–µ–∑ –ø–∞–Ω–∏–∫–∏

```python
# –ù–ê–ß–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
–±–∞–ª–∞–Ω—Å = $10,000
LONG: level=0, margin=$1, size=$75 @ $0.10
SHORT: level=0, margin=$1, size=$75 @ $0.10

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% ($0.10 ‚Üí $0.101) =======

# SHORT —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ triggered (—Ü–µ–Ω–∞ —É—à–ª–∞ –Ω–∞ 1% –≤–≤–µ—Ä—Ö)
next_margin = $1 √ó 2.0 = $2
SHORT: level=1, total_margin=$3, total_size=$225

# LONG TP triggered
LONG –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è: –ø—Ä–æ—Ñ–∏—Ç = $75 √ó 1% = $0.75
LONG –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è: level_diff=1 ‚Üí –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä $1
LONG: level=0, margin=$1, size=$75 @ $0.101

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–∞ –ø–µ—Ä–µ–¥ SHORT —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º:
safety_reserve = $3,840 (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
available = $10,000 - $3 (SHORT IM) - $1 (LONG IM) - $3,840 = $6,156
next_margin = $2
$6,156 >= $2 + $3,840? –î–ê ‚úÖ ‚Üí –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% ($0.101 ‚Üí $0.102) =======

SHORT —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ: next_margin = $2 √ó 2.0 = $4
SHORT: level=2, total_margin=$7, total_size=$525

LONG TP + reopen: margin=$1, size=$75 @ $0.102

available = $10,000 - $7 - $1 - $3,840 = $6,152
next_margin = $4
$6,152 >= $4 + $3,840? –ù–ï–¢ ‚ùå ‚Üí –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!

# –ù–û: $6,152 >= $3,840? –î–ê ‚Üí –†–µ–∑–µ—Ä–≤ —Ü–µ–ª, –º–æ–∂–µ–º —É—Å—Ä–µ–¥–Ω—è—Ç—å—Å—è
# (—Ñ–æ—Ä–º—É–ª–∞: available >= next_margin, –±–µ–∑ –≤—ã—á–µ—Ç–∞ reserve –≤—Ç–æ—Ä–æ–π —Ä–∞–∑)
available - next_margin = $6,152 - $4 = $6,148 > $3,840 ‚úÖ

–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ

# ======= –¶–ò–ö–õ –ü–†–û–î–û–õ–ñ–ê–ï–¢–°–Ø =======

# –ü–æ—Å–ª–µ 5 —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π SHORT:
SHORT: level=5, total_margin=$31, total_size=$2,325
LONG: level=0, margin=$1, size=$75

available = $10,000 - $31 - $1 - $3,840 = $6,128
next_SHORT_margin = $16 √ó 2.0 = $32

$6,128 >= $32? –î–ê ‚úÖ
$6,128 - $32 = $6,096 > $3,840? –î–ê ‚úÖ

–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ

# ======= –ò–¢–û–ì–û –ß–ï–†–ï–ó 10% –î–í–ò–ñ–ï–ù–ò–Ø =======

SHORT: level=10, total_margin=$1,023, total_size=$76,725
LONG: level=0, margin=$1, size=$75

available = $10,000 - $1,023 - $1 - $3,840 = $5,136
LONG PnL: ~$7.5 (10 TP –ø–æ $0.75)
SHORT unrealized PnL: ~-$7,308

IM metrics:
- Total IM used: $1,024
- Available: $5,136
- Available %: 51.4%
- MM Rate: ~15%

–ü–ê–ù–ò–ö–ê –ù–ï –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê! –†–µ–∑–µ—Ä–≤ —Ü–µ–ª, –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å ‚úÖ
```

### 5.2 –°—Ü–µ–Ω–∞—Ä–∏–π B: –ü–∞–Ω–∏–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞

```python
# –ù–ê–ß–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
–±–∞–ª–∞–Ω—Å = $5,000 (–º–µ–Ω—å—à–∏–π –¥–µ–ø–æ–∑–∏—Ç!)
LONG: level=0, margin=$1, size=$75 @ $0.10
SHORT: level=0, margin=$1, size=$75 @ $0.10

# ======= –î–í–ò–ñ–ï–ù–ò–ï +10% –ë–´–°–¢–†–û =======

# –ü–æ—Å–ª–µ 8 —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π SHORT:
SHORT: level=8, total_margin=$255, total_size=$19,125
LONG: level=0, margin=$1, size=$75

available = $5,000 - $255 - $1 - $3,840 = $904

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –ø–∞–Ω–∏–∫–∏:

# –¢—Ä–∏–≥–≥–µ—Ä 1: –ù–∏–∑–∫–∏–π IM
next_short = $128 √ó 2 = $256
next_long = $1
next_worst_case = $257
panic_threshold = $257 √ó 3 = $771

$904 < $771? –ù–ï–¢, $904 > $771 ‚úÖ

# –¢—Ä–∏–≥–≥–µ—Ä 2: –î–∏—Å–±–∞–ª–∞–Ω—Å + –Ω–∏–∑–∫–∏–π IM
level_diff = 8
available_percent = ($904 / $5,000) √ó 100 = 18.1%

level_diff >= 5? –î–ê (8 >= 5)
available_percent < 30%? –î–ê (18.1% < 30%)

–ü–ê–ù–ò–ö–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê! üö®
Reason: "IMBALANCE_LOW_IM: level_diff=8, available_IM=18.1%"

# ======= –î–ï–ô–°–¢–í–ò–Ø –í –ü–ê–ù–ò–ö–ï =======

# 1. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π
averaging_blocked = True

# 2. –°–Ω—è—Ç–∏–µ TP —É–±—ã—Ç–æ—á–Ω–æ–π (SHORT)
cancel_tp_order('Sell')
# LONG TP –æ—Å—Ç–∞–≤–ª–µ–Ω!

# 3. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
lagging = 'Buy'  # LONG –æ—Ç—Å—Ç–∞–µ—Ç
leading = 'Sell'  # SHORT –æ–ø–µ—Ä–µ–∂–∞–µ—Ç
margin_needed = $255 - $1 = $254

available_for_balancing = $904
$904 >= $254? –î–ê ‚úÖ

# –ü–æ–ª–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ!
buy_margin = $254
buy_qty = margin_to_qty($254, $0.11, 75) = 173,182 qty
buy_size = $19,068

LONG: level=8, total_margin=$255, total_size=$19,125
SHORT: level=8, total_margin=$255, total_size=$19,125

–°–ò–ú–ú–ï–¢–†–ò–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ê! ‚úÖ

available_after = $5,000 - $255 - $255 - $3,840 = $650

# 4. –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
panic_state = 'WAITING_STABILIZATION'

# ======= –ú–û–ù–ò–¢–û–†–ò–ù–ì –í –ü–ê–ù–ò–ö–ï =======

# –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫:
ATR = 2.5% (–≤—Å–µ –µ—â–µ –≤—ã—Å–æ–∫–∏–π)
MM Rate = 25%
Available IM = $650 (13%)

–¢—Ä–∏–≥–≥–µ—Ä—ã –≤—ã—Ö–æ–¥–∞ –ù–ï –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã (ATR –≤—ã—Å–æ–∫–∏–π)

# ======= –ß–ï–†–ï–ó 30 –ú–ò–ù–£–¢ =======

# –¶–µ–Ω–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å –Ω–∞ $0.108
ATR = 1.2% (—É–ø–∞–ª!)
ATR —Å—Ç–∞–±–∏–ª–µ–Ω 30 –º–∏–Ω—É—Ç ‚úÖ

# –ü—Ä–æ–≤–µ—Ä–∫–∞ IM:
next_worst_case = $512
threshold = $512 √ó 5 = $2,560
available = $650

$650 > $2,560? –ù–ï–¢ ‚ùå ‚Üí IM –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è

# –ñ–¥–µ–º –¥–∞–ª—å—à–µ...

# ======= –ß–ï–†–ï–ó 2 –ß–ê–°–ê: –û–¢–ö–ê–¢ =======

# –¶–µ–Ω–∞ —É–ø–∞–ª–∞ –Ω–∞ -2% ($0.108 ‚Üí $0.1058)

LONG PnL: +$192 (–ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–∏–±—ã–ª–∏)
SHORT PnL: -$95 (–ø–æ–∑–∏—Ü–∏—è –≤ —É–±—ã—Ç–∫–µ)

# LONG –±–æ–ª–µ–µ –ø—Ä–∏–±—ã–ª—å–Ω–∞, –Ω–æ TP –ù–ï –¥–æ—Å—Ç–∏–≥–Ω—É—Ç (–Ω—É–∂–Ω–æ +1% –æ—Ç avg)
# –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∂–¥–∞—Ç—å...

# ======= –ß–ï–†–ï–ó 4 –ß–ê–°–ê: LONG –î–û–°–¢–ò–ì TP! =======

LONG closed @ $0.102 (TP triggered)
Profit = $192

# –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ –ø–∞–Ω–∏–∫–∏!
exit_panic_mode("PROFITABLE_TP_HIT")

# ======= –ü–†–û–¶–ï–°–° –í–´–•–û–î–ê =======

# –®–∞–≥ 1: LONG —É–∂–µ –∑–∞–∫—Ä—ã—Ç (–ø–æ TP)

# –®–∞–≥ 2: –û—Ü–µ–Ω–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è SHORT
SHORT avg entry = $0.105
current_price = $0.102
loss_percent = (($0.105 - $0.102) / $0.105) √ó 100 = 2.86%

loss > 2%? –î–ê (2.86% > 2%)
new_level = 8 + 1 = 9
new_level <= 4? –ù–ï–¢ (9 > 4) ‚ùå

‚Üí –ù–ï —É—Å—Ä–µ–¥–Ω—è—Ç—å (–Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π)

# –®–∞–≥ 3: –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ LONG –∞–¥–∞–ø—Ç–∏–≤–Ω–æ
opposite_level = 8 (SHORT)
level_diff = 8
level_diff >= 4? –î–ê ‚Üí 100% SHORT

reopen_margin = $255 (100% SHORT)
available_after_close = $5,000 - $255 - $3,840 = $900

$900 >= $255 + $3,840? –ù–ï–¢ ($900 < $4,095)
–ù–û: $900 >= $255? –î–ê ‚úÖ

–ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å LONG —Å margin=$255

LONG: level=8, margin=$255, size=$19,125 @ $0.102
SHORT: level=8, margin=$255, size=$19,125 @ $0.105

–°–ò–ú–ú–ï–¢–†–ò–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ê –°–ù–û–í–ê! ‚úÖ

# –®–∞–≥ 4: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TP –¥–ª—è –æ–±–µ–∏—Ö
# –®–∞–≥ 5: –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è

panic_mode_active = False

# ======= –ò–¢–û–ì =======

–ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –ø–∞–Ω–∏–∫–∏: $5,192 (+$192 –ø—Ä–æ—Ñ–∏—Ç –æ—Ç LONG)
–ü–æ–∑–∏—Ü–∏–∏ —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã
–†–µ–∑–µ—Ä–≤ —Ü–µ–ª ($3,840)
–ë–æ—Ç –≤—ã–∂–∏–ª! ‚úÖ
```

### 5.3 –°—Ü–µ–Ω–∞—Ä–∏–π C: –ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∞

```python
# –ù–ê–ß–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
–±–∞–ª–∞–Ω—Å = $4,500 (–æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π!)
LONG: level=0, margin=$1, size=$75 @ $0.10
SHORT: level=0, margin=$1, size=$75 @ $0.10
safety_reserve = $3,840

available = $4,500 - $2 - $3,840 = $658

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% =======

# SHORT —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ triggered
next_margin = $2

# –ü–†–û–í–ï–†–ö–ê –†–ï–ó–ï–†–í–ê
available = $658
$658 >= $2? –î–ê ‚úÖ
$658 - $2 = $656 >= $3,840? –ù–ï–¢ ‚ùå

# –ù–æ —Ñ–æ—Ä–º—É–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è:
available_for_trading = total_balance - total_IM - safety_reserve
$4,500 - $2 - $3,840 = $658

if available_for_trading >= next_margin:
  —É—Å—Ä–µ–¥–Ω–∏—Ç—å

$658 >= $2? –î–ê ‚úÖ ‚Üí –£–°–†–ï–î–ù–ï–ù–ò–ï –†–ê–ó–†–ï–®–ï–ù–û

SHORT: level=1, total_margin=$3

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% =======

available = $4,500 - $3 - $1 - $3,840 = $656
next_margin = $4

$656 >= $4? –î–ê ‚úÖ ‚Üí –£–°–†–ï–î–ù–ï–ù–ò–ï –†–ê–ó–†–ï–®–ï–ù–û

SHORT: level=2, total_margin=$7

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% =======

available = $4,500 - $7 - $1 - $3,840 = $652
next_margin = $8

$652 >= $8? –î–ê ‚úÖ ‚Üí –£–°–†–ï–î–ù–ï–ù–ò–ï –†–ê–ó–†–ï–®–ï–ù–û

SHORT: level=3, total_margin=$15

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% =======

available = $4,500 - $15 - $1 - $3,840 = $644
next_margin = $16

$644 >= $16? –î–ê ‚úÖ ‚Üí –£–°–†–ï–î–ù–ï–ù–ò–ï –†–ê–ó–†–ï–®–ï–ù–û

SHORT: level=4, total_margin=$31

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% =======

available = $4,500 - $31 - $1 - $3,840 = $628
next_margin = $32

$628 >= $32? –î–ê ‚úÖ ‚Üí –£–°–†–ï–î–ù–ï–ù–ò–ï –†–ê–ó–†–ï–®–ï–ù–û

SHORT: level=5, total_margin=$63

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% =======

available = $4,500 - $63 - $1 - $3,840 = $596
next_margin = $64

$596 >= $64? –î–ê ‚úÖ ‚Üí –£–°–†–ï–î–ù–ï–ù–ò–ï –†–ê–ó–†–ï–®–ï–ù–û

SHORT: level=6, total_margin=$127

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% =======

available = $4,500 - $127 - $1 - $3,840 = $532
next_margin = $128

$532 >= $128? –î–ê ‚úÖ ‚Üí –£–°–†–ï–î–ù–ï–ù–ò–ï –†–ê–ó–†–ï–®–ï–ù–û

SHORT: level=7, total_margin=$255

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% =======

available = $4,500 - $255 - $1 - $3,840 = $404
next_margin = $256

$404 >= $256? –î–ê ‚úÖ ‚Üí –£–°–†–ï–î–ù–ï–ù–ò–ï –†–ê–ó–†–ï–®–ï–ù–û

SHORT: level=8, total_margin=$511

# ======= –î–í–ò–ñ–ï–ù–ò–ï +1% =======

available = $4,500 - $511 - $1 - $3,840 = $148
next_margin = $512

$148 >= $512? –ù–ï–¢ ‚ùå

# –£–°–†–ï–î–ù–ï–ù–ò–ï –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û! üõë

LOG: "Reserve check FAILED: available=$148, needed=$512, reserve=$3,840.
     BLOCKING averaging to preserve emergency funds!"

# SHORT –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ level=8
# –†–µ–∑–µ—Ä–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: $3,840
# Available: $148 (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è, –Ω–æ —Ä–µ–∑–µ—Ä–≤ —Ü–µ–ª!)

# ======= –ü–†–û–í–ï–†–ö–ê –¢–†–ò–ì–ì–ï–†–û–í –ü–ê–ù–ò–ö–ò =======

# –¢—Ä–∏–≥–≥–µ—Ä 1: –ù–∏–∑–∫–∏–π IM
next_worst_case = $512 (SHORT) + $1 (LONG) = $513
panic_threshold = $513 √ó 3 = $1,539

$148 < $1,539? –î–ê ‚Üí –ü–ê–ù–ò–ö–ê! üö®

# –ü–ê–ù–ò–ö–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê
# –ù–æ —Ä–µ–∑–µ—Ä–≤ –ï–©–ï –ï–°–¢–¨ ($3,840)!
# –ú–æ–∂–µ–º –≤—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏

# –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ:
margin_needed = $511 - $1 = $510
available_for_balancing = $148

$148 >= $510? –ù–ï–¢

# –ß–∞—Å—Ç–∏—á–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ $148
balance_percentage = ($148 / $510) √ó 100 = 29%

LONG –¥–æ–∫—É–ø–∏—Ç—å: margin=$148
LONG: level=8 (partial), total_margin=$149

SHORT: total_margin=$511
LONG: total_margin=$149

Balance ratio = $149 / $511 = 29% (–Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ, –Ω–æ –ª—É—á—à–µ —á–µ–º 0.2%)

# –ö–ê–¢–ê–°–¢–†–û–§–ê –ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ê! ‚úÖ
# –†–µ–∑–µ—Ä–≤ —Ü–µ–ª, –ø–æ–∑–∏—Ü–∏–∏ —á–∞—Å—Ç–∏—á–Ω–æ –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã, –∂–¥–µ–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
```

---

## 6. –ü—Å–µ–≤–¥–æ–∫–æ–¥ –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

```python
# ============================================================
#                   –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ –ë–û–¢–ê
# ============================================================

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
panic_mode_active = False
panic_state = None  # 'WAITING_STABILIZATION' –∏–ª–∏ None
averaging_blocked = False

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∏–∑ config.yaml)
symbol = "DOGEUSDT"
max_grid_levels = 10
multiplier = 2.0
leverage = 75
initial_position_size_usd = 1.0
take_profit_percent = 1.0


def main_loop():
    """
    –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –±–æ—Ç–∞ - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º price update
    """
    while True:
        try:
            # 1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
            current_price = get_current_price()

            # 2. –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ IM (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
            if should_update_im_metrics():
                im_metrics = monitor_initial_margin()

            # 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –ø–∞–Ω–∏–∫–∏
            if not panic_mode_active:
                panic_triggered, panic_reason = check_all_panic_triggers()

                if panic_triggered:
                    # –í–æ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏
                    enter_panic_mode(panic_reason)

            # 4. –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
            if panic_mode_active:
                # –†–ï–ñ–ò–ú –ü–ê–ù–ò–ö–ò
                handle_panic_mode(current_price)
            else:
                # –û–ë–´–ß–ù–ê–Ø –†–ê–ë–û–¢–ê
                handle_normal_operation(current_price)

            # 5. –°–æ–Ω –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            time.sleep(0.1)  # 100ms

        except Exception as e:
            logger.error(f"Error in main loop: {e}", exc_info=True)
            time.sleep(1)


def handle_normal_operation(current_price: float):
    """
    –û–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–æ—Ç–∞ (–Ω–µ –≤ –ø–∞–Ω–∏–∫–µ)
    """
    # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ TP (–µ—Å–ª–∏ –µ—Å—Ç—å)
    # –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ WebSocket callback

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π
    for side in ['Buy', 'Sell']:
        if should_execute_averaging(side, current_price):
            execute_averaging_with_reserve_check(side, current_price)

    # 3. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 60 —Å–µ–∫)
    if should_sync_with_exchange():
        sync_with_exchange(current_price)


def handle_panic_mode(current_price: float):
    """
    –†–∞–±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –ø–∞–Ω–∏–∫–∏
    """
    global panic_state

    if panic_state == 'WAITING_STABILIZATION':
        # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –≤—ã—Ö–æ–¥–∞
        should_exit, exit_reason = check_panic_exit_triggers()

        if should_exit:
            exit_panic_mode(exit_reason)

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫
    if should_log_panic_status():
        log_panic_status()


# ============================================================
#                –ê–î–ê–ü–¢–ò–í–ù–û–ï –ü–ï–†–ï–û–¢–ö–†–´–¢–ò–ï
# ============================================================

def on_position_closed_by_tp(closed_side: str, close_price: float):
    """
    WebSocket callback: –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ TP
    """
    # –ï—Å–ª–∏ –≤ –ø–∞–Ω–∏–∫–µ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥
    if panic_mode_active:
        on_tp_closed_during_panic(closed_side, close_price)
        return

    # –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    logger.info(f"TP closed: {closed_side} @ ${close_price:.4f}")

    # –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ
    opposite_side = 'Sell' if closed_side == 'Buy' else 'Buy'
    opposite_level = position_manager.get_grid_level(opposite_side)
    level_diff = opposite_level  # closed_level = 0

    # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏—è
    opposite_margin = position_manager.get_total_margin(opposite_side)

    if level_diff >= 4:
        reopen_margin = opposite_margin
        reopen_coef = "100%"
    elif level_diff == 3:
        reopen_margin = opposite_margin * 0.5
        reopen_coef = "50%"
    elif level_diff == 2:
        reopen_margin = opposite_margin * 0.25
        reopen_coef = "25%"
    else:
        reopen_margin = initial_position_size_usd
        reopen_coef = "initial"

    logger.info(
        f"Adaptive reopen: diff={level_diff} ‚Üí {reopen_coef} "
        f"(${reopen_margin:.2f} margin)"
    )

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–∞
    safety_reserve = calculate_safety_reserve(
        symbol, max_grid_levels, multiplier, leverage, close_price
    )

    if not check_reserve_before_averaging(closed_side, reopen_margin, safety_reserve):
        # –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        im_metrics = monitor_initial_margin()
        max_reopen = im_metrics['available_for_trading'] - safety_reserve

        if max_reopen > 0:
            reopen_margin = max_reopen
            logger.warning(f"Reopening with reduced size: ${reopen_margin:.2f}")
        else:
            logger.error("Cannot reopen: insufficient IM")
            return

    # –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å
    reopen_qty = margin_to_qty(reopen_margin, close_price, leverage)

    if not dry_run:
        bybit_client.place_order(
            symbol=symbol,
            side=closed_side,
            qty=reopen_qty,
            order_type='Market'
        )

    # –û–±–Ω–æ–≤–∏—Ç—å position manager
    new_level = opposite_level if level_diff >= 4 else 0
    position_manager.add_position(
        side=closed_side,
        entry_price=close_price,
        quantity=reopen_qty,
        grid_level=new_level
    )

    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TP
    update_tp_order(closed_side)


# ============================================================
#             –ü–†–û–í–ï–†–ö–ê –†–ï–ó–ï–†–í–ê –ò –£–°–†–ï–î–ù–ï–ù–ò–Ø
# ============================================================

def should_execute_averaging(side: str, current_price: float) -> bool:
    """
    –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    """
    # 1. –ï—Å–ª–∏ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã (–ø–∞–Ω–∏–∫–∞) ‚Üí –Ω–µ—Ç
    if averaging_blocked:
        return False

    # 2. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if not should_add_position(side, current_price):
        return False

    if position_manager.get_position_count(side) >= max_grid_levels:
        return False

    # 3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–∞—Ä–∂—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    next_margin = calculate_next_averaging_margin(side)

    # 4. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –†–ï–ó–ï–†–í–ê
    safety_reserve = calculate_safety_reserve(
        symbol, max_grid_levels, multiplier, leverage, current_price
    )

    if not check_reserve_before_averaging(side, next_margin, safety_reserve):
        return False

    return True


def execute_averaging_with_reserve_check(side: str, current_price: float):
    """
    –í—ã–ø–æ–ª–Ω–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —Å —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–µ–∑–µ—Ä–≤–∞
    """
    next_margin = calculate_next_averaging_margin(side)
    next_qty = margin_to_qty(next_margin, current_price, leverage)
    current_level = position_manager.get_grid_level(side)

    logger.info(
        f"Executing averaging: {side} level {current_level} ‚Üí {current_level + 1}, "
        f"margin=${next_margin:.2f}"
    )

    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ä–¥–µ—Ä–æ–º
    safety_reserve = calculate_safety_reserve(
        symbol, max_grid_levels, multiplier, leverage, current_price
    )

    if not check_reserve_before_averaging(side, next_margin, safety_reserve):
        logger.error("Reserve check failed at execution time - skipping")
        return

    # –í—ã–ø–æ–ª–Ω–∏—Ç—å
    if not dry_run:
        bybit_client.place_order(
            symbol=symbol,
            side=side,
            qty=next_qty,
            order_type='Market'
        )

    # –û–±–Ω–æ–≤–∏—Ç—å position manager
    position_manager.add_position(
        side=side,
        entry_price=current_price,
        quantity=next_qty,
        grid_level=current_level + 1
    )

    # –û–±–Ω–æ–≤–∏—Ç—å TP
    update_tp_order(side)

    # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ IM
    im_metrics = monitor_initial_margin()
    logger.info(
        f"After averaging: available_IM=${im_metrics['available_for_trading']:.2f} "
        f"({im_metrics['available_percent']:.1f}%)"
    )


# ============================================================
#                   –†–ï–ñ–ò–ú –ü–ê–ù–ò–ö–ò (–ü–û–õ–ù–´–ô –¶–ò–ö–õ)
# ============================================================

def enter_panic_mode(reason: str):
    """
    –í–æ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏ - –ø–æ–ª–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    """
    global panic_mode_active, panic_state, averaging_blocked

    logger.error(f"üö® PANIC MODE ACTIVATED: {reason}")

    # 1. –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    averaging_blocked = True

    # 2. –°–Ω—è—Ç—å TP —É–±—ã—Ç–æ—á–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
    cancel_tp_for_losing_side()

    # 3. –í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏
    balance_positions_adaptive()

    # 4. –ü–µ—Ä–µ–π—Ç–∏ –≤ –æ–∂–∏–¥–∞–Ω–∏–µ
    panic_state = 'WAITING_STABILIZATION'
    panic_mode_active = True

    logger.info("Panic mode setup completed. Waiting for stabilization...")


def check_panic_exit_triggers() -> (bool, str):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø–∞–Ω–∏–∫–∏
    """
    # –¢—Ä–∏–≥–≥–µ—Ä 1: TP –ø—Ä–æ—Ñ–∏—Ç–Ω–æ–π (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
    # –¢—Ä–∏–≥–≥–µ—Ä 2: IM + –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
    if check_exit_trigger_im_and_volatility():
        return (True, "IM_AND_VOLATILITY_RECOVERED")

    return (False, "")


def on_tp_closed_during_panic(closed_side: str, close_price: float):
    """
    TP –≤–æ –≤—Ä–µ–º—è –ø–∞–Ω–∏–∫–∏ - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥
    """
    logger.info(f"TP closed during panic: {closed_side} @ ${close_price:.4f}")
    exit_panic_mode("PROFITABLE_TP_HIT")


def exit_panic_mode(reason: str):
    """
    –í—ã–π—Ç–∏ –∏–∑ –ø–∞–Ω–∏–∫–∏
    """
    global panic_mode_active, panic_state

    logger.info(f"üü¢ EXITING PANIC MODE: {reason}")

    # –ü—Ä–æ—Ü–µ—Å—Å –≤—ã—Ö–æ–¥–∞
    process_panic_exit()

    # –°–±—Ä–æ—Å —Ñ–ª–∞–≥–æ–≤
    panic_mode_active = False
    panic_state = None

    logger.info("Panic mode DEACTIVATED")


# ============================================================
#              –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ============================================================

def calculate_next_averaging_margin(side: str) -> float:
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–∞—Ä–∂—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    """
    positions = (position_manager.long_positions if side == 'Buy'
                 else position_manager.short_positions)

    if not positions:
        return initial_position_size_usd

    # –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞—Ä—Ç–∏–Ω–≥–µ–π–ª: –ø–æ—Å–ª–µ–¥–Ω—è—è –º–∞—Ä–∂–∞ √ó multiplier
    last_position = positions[-1]
    current_price = get_current_price()
    last_position_value = last_position.quantity * current_price
    last_position_margin = last_position_value / leverage

    next_margin = last_position_margin * multiplier
    return next_margin


def margin_to_qty(margin: float, price: float, leverage: int) -> float:
    """
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä–∂—É –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç
    """
    position_value = margin * leverage
    qty = position_value / price

    # –û–∫—Ä—É–≥–ª–∏—Ç—å –¥–æ qty_step
    qty_step = get_qty_step(symbol)
    num_steps = round(qty / qty_step)
    rounded_qty = num_steps * qty_step

    return max(rounded_qty, get_min_qty(symbol))


def block_all_averaging():
    """–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è"""
    global averaging_blocked
    averaging_blocked = True


def unblock_all_averaging():
    """–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è"""
    global averaging_blocked
    averaging_blocked = False


# ============================================================
#                      –¢–û–ß–ö–ê –í–•–û–î–ê
# ============================================================

if __name__ == "__main__":
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initialize_bot()

    # –ó–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
    main_loop()
```

---

## 7. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
# Advanced Risk Management Configuration
# –í–µ—Ä—Å–∏—è: 2.0 (Initial Margin-first approach)

# –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
strategy:
  symbol: "DOGEUSDT"
  category: "linear"
  leverage: 75                              # –ü–ª–µ—á–æ (–í–´–°–û–ö–ò–ô –†–ò–°–ö!)
  initial_position_size_usd: 1.0            # –ù–∞—á–∞–ª—å–Ω–∞—è –º–∞—Ä–∂–∞
  grid_step_percent: 1.0                    # –®–∞–≥ grid (%)
  averaging_multiplier: 2.0                 # –ú–∞—Ä—Ç–∏–Ω–≥–µ–π–ª –º–Ω–æ–∂–∏—Ç–µ–ª—å
  take_profit_percent: 1.0                  # Take profit (%)
  max_grid_levels_per_side: 10              # –ú–∞–∫—Å —É—Ä–æ–≤–Ω–µ–π grid

# Initial Margin —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
initial_margin:
  # Safety reserve (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç)
  safety_reserve:
    safety_factor: 2.0                      # –ú–Ω–æ–∂–∏—Ç–µ–ª—å –∑–∞–ø–∞—Å–∞ (2√ó worst case)
    funding_reserve_days: 30                # –†–µ–∑–µ—Ä–≤ –Ω–∞ N –¥–Ω–µ–π —Ñ–∞–Ω–¥–∏–Ω–≥–æ–≤

  # –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º
  averaging_checks:
    always_check_reserve: true              # –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–µ–∑–µ—Ä–≤
    block_if_insufficient: true             # –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
  monitoring:
    update_interval_seconds: 60             # –û–±–Ω–æ–≤–ª—è—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫
    log_warnings:
      low_im_percent: 30.0                  # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ < 30%
      critical_im_percent: 15.0             # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å < 15%

# –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ
adaptive_reopen:
  enabled: true                             # –í–∫–ª—é—á–∏—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ
  level_thresholds:
    full_reopen: 4                          # >= 4 —É—Ä–æ–≤–Ω—è ‚Üí 100% –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π
    half_reopen: 3                          # 3 —É—Ä–æ–≤–Ω—è ‚Üí 50%
    quarter_reopen: 2                       # 2 —É—Ä–æ–≤–Ω—è ‚Üí 25%
    initial_reopen: 1                       # <= 1 —É—Ä–æ–≤–µ–Ω—å ‚Üí –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä

# –†–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏
panic_mode:
  enabled: true                             # –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏

  # –¢—Ä–∏–≥–≥–µ—Ä—ã –≤—Ö–æ–¥–∞
  entry_triggers:
    # –¢—Ä–∏–≥–≥–µ—Ä 1: –ù–∏–∑–∫–∏–π Available IM
    low_im:
      enabled: true
      comfort_factor: 3                     # Available IM < next_avg √ó 3

    # –¢—Ä–∏–≥–≥–µ—Ä 2: –î–∏—Å–±–∞–ª–∞–Ω—Å + –ù–∏–∑–∫–∏–π IM
    imbalance_low_im:
      enabled: true
      level_diff_threshold: 5               # –î–∏—Å–±–∞–ª–∞–Ω—Å >= 5 —É—Ä–æ–≤–Ω–µ–π
      available_percent_threshold: 30.0     # Available IM < 30%

    # –¢—Ä–∏–≥–≥–µ—Ä 3: High MM Rate (–∞–≤–∞—Ä–∏–π–Ω—ã–π)
    high_mm_rate:
      enabled: true
      threshold: 70.0                       # MM Rate >= 70%

  # –î–µ–π—Å—Ç–≤–∏—è –≤ –ø–∞–Ω–∏–∫–µ
  actions:
    block_averaging: true                   # –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
    cancel_tp_losing_side: true             # –°–Ω—è—Ç—å TP —É–±—ã—Ç–æ—á–Ω–æ–π
    keep_tp_profitable_side: true           # –û—Å—Ç–∞–≤–∏—Ç—å TP –ø—Ä–æ—Ñ–∏—Ç–Ω–æ–π
    balance_positions: true                 # –í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏

  # –¢—Ä–∏–≥–≥–µ—Ä—ã –≤—ã—Ö–æ–¥–∞
  exit_triggers:
    # –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥: –ø—Ä–æ—Ñ–∏—Ç–Ω–∞—è –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ TP
    profitable_tp_hit:
      enabled: true

    # –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π –≤—ã—Ö–æ–¥: IM + –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
    im_and_volatility:
      enabled: true
      im_recovery_factor: 5                 # Available IM > next_avg √ó 5
      atr_threshold_percent: 1.5            # ATR < 1.5%
      atr_stable_duration_minutes: 30       # ATR —Å—Ç–∞–±–∏–ª–µ–Ω 30 –º–∏–Ω—É—Ç
      mm_rate_safe_threshold: 40.0          # MM Rate < 40%
      require_all_conditions: true          # –í–°–ï —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

  # –í—ã—Ö–æ–¥ –∏–∑ –ø–∞–Ω–∏–∫–∏
  exit_process:
    close_profitable: true                  # –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–±—ã–ª—å–Ω—É—é
    evaluate_averaging_losing: true         # –û—Ü–µ–Ω–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —É–±—ã—Ç–æ—á–Ω–æ–π
    averaging_loss_threshold: 2.0           # –£—Å—Ä–µ–¥–Ω—è—Ç—å –µ—Å–ª–∏ —É–±—ã—Ç–æ–∫ > 2%
    averaging_max_new_level: 4              # –ù–µ —É—Å—Ä–µ–¥–Ω—è—Ç—å –µ—Å–ª–∏ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å > 4
    adaptive_reopen: true                   # –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ –∑–∞–∫—Ä—ã—Ç–æ–π
    restore_tp: true                        # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TP –æ—Ä–¥–µ—Ä–∞
    unblock_averaging: true                 # –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è

# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–æ–ª—É—á–∞—é—Ç—Å—è –∏–∑ API)
dynamic_parameters:
  # –í—Å–µ —ç—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—É—á–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ Bybit API
  # –ó–Ω–∞—á–µ–Ω–∏—è –Ω–∏–∂–µ - —Ç–æ–ª—å–∫–æ –¥–ª—è reference, –ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é!

  im_rate:
    source: "bybit_api"                     # get_margin_trading_info()
    fallback_formula: "1.0 / leverage"      # –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

  taker_fee_rate:
    source: "bybit_api"                     # get_fee_rate()
    reference_value: 0.00055                # 0.055% (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)

  maker_fee_rate:
    source: "bybit_api"                     # get_fee_rate()
    reference_value: 0.0002                 # 0.02% (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)

  funding_rate:
    source: "bybit_api"                     # get_funding_rate_history()
    history_days: 30                        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
    reference_value: 0.0001                 # 0.01% per 8h (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)

  atr:
    calculation: "real_time"                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    period: 14                              # 14-period ATR
    interval: "1"                           # 1-–º–∏–Ω—É—Ç–Ω—ã–µ —Å–≤–µ—á–∏

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging:
  level: "INFO"                             # DEBUG | INFO | WARNING | ERROR
  file_rotation: "daily"                    # –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤

  # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
  panic_mode_log: true                      # –û—Ç–¥–µ–ª—å–Ω—ã–π –ª–æ–≥ –¥–ª—è –ø–∞–Ω–∏–∫–∏
  im_monitoring_log: true                   # –û—Ç–¥–µ–ª—å–Ω—ã–π –ª–æ–≥ –¥–ª—è IM –º–µ—Ç—Ä–∏–∫
  reserve_check_log: true                   # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ–∑–µ—Ä–≤–∞

# –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã
mode:
  dry_run: false                            # false = real trading
  demo_trading: true                        # true = demo environment
```

---

## 8. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (Atomicity & Concurrency)

### 8.1 Race Conditions –≤ Multi-Symbol Account

**–ü—Ä–æ–±–ª–µ–º–∞:**

```python
# Thread 1 (DOGEUSDT WebSocket callback):
check_reserve_before_averaging()  # available = $100, reserve = $50 ‚úÖ
# ... (1ms delay)
place_order(qty=...)  # Execute

# Thread 2 (TONUSDT WebSocket callback) –í –¢–û –ñ–ï –í–†–ï–ú–Ø:
check_reserve_before_averaging()  # available = $100, reserve = $50 ‚úÖ
# ... (1ms delay)
place_order(qty=...)  # Execute

# –†–ï–ó–£–õ–¨–¢–ê–¢: –û–±–∞ —É–≤–∏–¥–µ–ª–∏ $100 available, –æ–±–∞ —Ä–∞–∑–º–µ—Å—Ç–∏–ª–∏ –æ—Ä–¥–µ—Ä–∞!
# Real available –ø–æ—Å–ª–µ –æ–±–æ–∏—Ö –æ—Ä–¥–µ—Ä–æ–≤: –º–æ–∂–µ—Ç –±—ã—Ç—å < reserve!
```

**–†–µ—à–µ–Ω–∏–µ: Account-Level Lock**

```python
# –í TradingAccount
class TradingAccount:
    def __init__(self, ...):
        self._account_lock = threading.Lock()  # ONE lock per account

    def check_reserve_before_averaging(
        self,
        symbol: str,
        side: str,
        next_averaging_margin: float
    ) -> bool:
        """
        THREAD-SAFE –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–∞ –¥–ª—è ANY symbol
        """
        with self._account_lock:  # CRITICAL SECTION
            # 1. Snapshot –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
            total_available = self.balance_manager.get_available_balance()
            safety_reserve = self.calculate_account_safety_reserve()
            available_for_trading = total_available - safety_reserve

            # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞
            if available_for_trading >= next_averaging_margin:
                return True
            else:
                return False

    def execute_averaging_atomic(
        self,
        strategy,
        side: str,
        current_price: float
    ) -> bool:
        """
        –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —Å re-validation
        """
        with self._account_lock:  # CRITICAL SECTION
            # 1. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            next_margin = strategy.calculate_next_averaging_margin(side)

            # 2. RE-VALIDATE –ø–µ—Ä–µ–¥ –æ—Ä–¥–µ—Ä–æ–º (check-then-act safety)
            if not self.check_reserve_before_averaging(
                strategy.symbol, side, next_margin
            ):
                logger.warning(
                    f"[{strategy.symbol}] Reserve check failed at execution time "
                    f"(race condition or balance changed)"
                )
                return False

            # 3. Execute order
            try:
                next_qty = strategy.margin_to_qty(next_margin, current_price)

                if not strategy.dry_run:
                    order = strategy.client.place_order(
                        symbol=strategy.symbol,
                        side=side,
                        qty=next_qty,
                        order_type='Market'
                    )

                # 4. Update position manager
                current_level = strategy.position_manager.get_grid_level(side)
                strategy.position_manager.add_position(
                    side=side,
                    entry_price=current_price,
                    quantity=next_qty,
                    grid_level=current_level + 1
                )

                logger.info(
                    f"[{strategy.symbol}] Averaging executed: {side} "
                    f"level {current_level} ‚Üí {current_level + 1}, margin=${next_margin:.2f}"
                )

                return True

            except Exception as e:
                logger.error(f"[{strategy.symbol}] Order execution failed: {e}")
                # Position manager –ù–ï –æ–±–Ω–æ–≤–ª–µ–Ω ‚Üí automatic rollback
                return False
```

### 8.2 Check-Then-Act Pattern Safety

```python
# ‚ùå –û–ü–ê–°–ù–û (race condition):
if check_reserve():
    # ... (—Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –∑–¥–µ—Å—å!)
    place_order()

# ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û (re-validation):
with account_lock:
    if check_reserve():
        if check_reserve():  # RE-VALIDATE!
            place_order()

# ‚úÖ –ï–©–Å –ë–ï–ó–û–ü–ê–°–ù–ï–ï (atomic operation):
with account_lock:
    snapshot = get_all_state()
    if validate_snapshot(snapshot):
        execute_with_snapshot(snapshot)
```

### 8.3 WebSocket Callback Threads

```python
# –í—Å–µ WebSocket callbacks –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ SEPARATE THREADS!

# Wallet callback (thread A):
def on_wallet_update(wallet_data):
    balance_manager.update_from_websocket(...)  # Thread-safe (has own lock)

# Position callback (thread B):
def on_position_update(position_data):
    position_manager.update_position(...)  # Thread-safe (has own lock)

# Price callback (thread C):
def on_price_update(price):
    # –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å execute_averaging() ‚Üí –Ω—É–∂–µ–Ω account_lock!
    strategy.on_price_update(price)

# –í–ê–ñ–ù–û: account_lock –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç race conditions –º–µ–∂–¥—É threads
```

### 8.4 Order Execution Failures & Rollback

```python
def execute_averaging_with_rollback(side: str, current_price: float):
    """
    –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —Å rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    """
    with account_lock:
        # 1. Snapshot —Å–æ—Å—Ç–æ—è–Ω–∏—è –î–û –æ—Ä–¥–µ—Ä–∞
        snapshot = {
            'position_count': position_manager.get_position_count(side),
            'total_qty': position_manager.get_total_quantity(side),
            'grid_level': position_manager.get_grid_level(side)
        }

        # 2. Execute
        try:
            order = place_order(...)

            # 3. –ï—Å–ª–∏ –æ—Ä–¥–µ—Ä —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª–Ω–µ–Ω
            if order['status'] == 'PartiallyFilled':
                actual_qty = float(order['cumExecQty'])
                logger.warning(
                    f"Partial fill: requested={requested_qty}, filled={actual_qty}"
                )
                # Update position manager —Å actual_qty (–ù–ï requested!)
                position_manager.add_position(
                    side=side,
                    entry_price=float(order['avgPrice']),
                    quantity=actual_qty,  # ACTUAL!
                    grid_level=snapshot['grid_level'] + 1
                )

            # 4. –ï—Å–ª–∏ –æ—Ä–¥–µ—Ä rejected
            elif order['status'] == 'Rejected':
                logger.error(f"Order rejected: {order['rejectReason']}")
                # Position manager –ù–ï –æ–±–Ω–æ–≤–ª–µ–Ω ‚Üí automatic rollback ‚úÖ
                return False

        except Exception as e:
            logger.error(f"Order execution exception: {e}")
            # Position manager –ù–ï –æ–±–Ω–æ–≤–ª–µ–Ω ‚Üí automatic rollback ‚úÖ
            return False
```

### 8.5 Price Changes During Execution

```python
# –ü—Ä–æ–±–ª–µ–º–∞: —Ü–µ–Ω–∞ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –º–µ–∂–¥—É check –∏ execute

# Snapshot price at check time
snapshot_price = get_current_price()  # $0.150

# Calculate margin needed
next_margin = calculate_next_averaging_margin(side)  # $32
reserve = calculate_safety_reserve(snapshot_price)  # Based on $0.150

# Check passed
if available >= next_margin + reserve:
    # ... (50ms delay)

    # Price changed!
    execution_price = get_current_price()  # $0.155 (+3.3%!)

    # Place order
    place_order(qty=...)  # Executed @ $0.155

    # Real margin used:
    # real_margin = (qty √ó $0.155) / leverage
    # real_margin –º–æ–∂–µ—Ç –±—ã—Ç—å > next_margin!

# –†–ï–®–ï–ù–ò–ï: gap_buffer –≤ safety_factor –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —ç—Ç–æ!
# reserve √ó 1.20-1.25 = –∑–∞–ø–∞—Å –Ω–∞ —Ü–µ–Ω–æ–≤—ã–µ —Å–∫–∞—á–∫–∏ ‚úÖ
```

### 8.6 Unified Account Concurrency

```python
# Unified Account = –í–°–ï —Å–∏–º–≤–æ–ª—ã share ONE margin pool
# –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ DOGEUSDT –≤–ª–∏—è—é—Ç –Ω–∞ available –¥–ª—è TONUSDT!

# –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: Account-level lock –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

# –ü—Ä–∏–º–µ—Ä –±–µ–∑ lock (–û–ü–ê–°–ù–û):
# DOGEUSDT: check_reserve() ‚Üí available=$100 ‚úÖ
# TONUSDT: check_reserve() ‚Üí available=$100 ‚úÖ (–û–î–ù–û–í–†–ï–ú–ï–ù–ù–û!)
# DOGEUSDT: place_order($50)
# TONUSDT: place_order($50)
# –†–ï–ó–£–õ–¨–¢–ê–¢: $100 total used, reserve breached!

# –ü—Ä–∏–º–µ—Ä —Å lock (–ë–ï–ó–û–ü–ê–°–ù–û):
# DOGEUSDT: acquires lock ‚Üí check ‚Üí execute ‚Üí releases lock
# TONUSDT: waits for lock ‚Üí check ‚Üí sees updated available ‚Üí executes safely
```

### 8.7 Summary: –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏

| –ú–µ—Ö–∞–Ω–∏–∑–º | –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç |
|----------|-------------|
| `account_lock` | –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ |
| Re-validation | Check-then-act race conditions |
| Thread-safe BalanceManager | WebSocket callback conflicts |
| Rollback on exception | –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ/rejected –æ—Ä–¥–µ—Ä–∞ |
| gap_buffer –≤ reserve | –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –º–µ–∂–¥—É check –∏ execute |
| Atomic operations | –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ position manager |

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
1. ‚úÖ **ONE lock per account** - –≤—Å–µ critical –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã
2. ‚úÖ **Re-validate before execute** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–≤–∞–∂–¥—ã (check + execute)
3. ‚úÖ **Automatic rollback** - –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å state –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
4. ‚úÖ **Thread-safe components** - BalanceManager, PositionManager –∏–º–µ—é—Ç —Å–≤–æ–∏ locks
5. ‚úÖ **Gap buffers** - –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã/—Å–æ—Å—Ç–æ—è–Ω–∏—è
6. ‚úÖ **Idempotency** - –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ

**–í—ã–≤–æ–¥:** –° account-level lock –∏ re-validation –±–æ—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è multi-symbol concurrent execution. WebSocket-first –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ + threading locks = –Ω–∞–¥–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑ race conditions.

---

## –§–∏–Ω–∞–ª: –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

1. **Initial Margin - –æ—Å–Ω–æ–≤–∞ –≤—Å–µ–≥–æ**
   - –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–º–µ—Å—Ç–æ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ (MM Rate)
   - –†–µ–∑–µ—Ä–≤ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π –î–û –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞

2. **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏–º–º–µ—Ç—Ä–∏–∏ –ø–æ—Å–ª–µ TP
   - –í–æ–∑–≤—Ä–∞—Ç –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º —á–µ—Ä–µ–∑ 2-3 —Ü–∏–∫–ª–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ–º

3. **–†–µ–∂–∏–º –ø–∞–Ω–∏–∫–∏ = —Ä–µ–∂–∏–º –≤—ã–∂–∏–≤–∞–Ω–∏—è**
   - –¢—Ä–∏–≥–≥–µ—Ä—ã: –Ω–∏–∑–∫–∏–π IM, –¥–∏—Å–±–∞–ª–∞–Ω—Å+–Ω–∏–∑–∫–∏–π IM, high MM Rate
   - –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π (–Ω–µ emergency close!)
   - –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
   - –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π –≤—ã—Ö–æ–¥ —Å –ø—Ä–æ—Ñ–∏—Ç–æ–º

4. **–ù–∏–∫–∞–∫–∏—Ö hardcoded –∑–Ω–∞—á–µ–Ω–∏–π**
   - –ö–æ–º–∏—Å—Å–∏–∏ ‚Üí –∏–∑ Bybit API
   - Funding rates ‚Üí –∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
   - IM rate ‚Üí –∏–∑ Bybit margin info
   - ATR ‚Üí –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

- **–†–µ–∑–µ—Ä–≤ –í–°–ï–ì–î–ê –¥–æ—Å—Ç—É–ø–µ–Ω** –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –≤ worst case
- **–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞ –ù–ï–í–û–ó–ú–û–ñ–ù–ê** (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π)
- **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤ —É–±—ã—Ç–æ–∫** (—Ç–æ–ª—å–∫–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ)
- **100% –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** (–±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞)

### ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏

–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç:
- ‚úÖ –ü–æ–ª–Ω—É—é –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
- ‚úÖ –ì–æ—Ç–æ–≤—ã–π –ø—Å–µ–≤–¥–æ–∫–æ–¥ –¥–ª—è –≤—Å–µ—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Å —á–∏—Å–ª–∞–º–∏
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ YAML

**–ì–æ—Ç–æ–≤–æ –∫ –ø–µ—Ä–µ–≤–æ–¥—É –≤ Python –∫–æ–¥!** üöÄ

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 13 –æ–∫—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è:** 2.0
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –≥–ª—É–±–æ–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É –∏ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏
