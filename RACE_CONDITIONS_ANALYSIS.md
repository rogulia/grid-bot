# Race Conditions Analysis

## –°—Ç–∞—Ç—É—Å: ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û –†–ï–®–ï–ù–û

–û—Å–Ω–æ–≤–Ω–∞—è race condition —Ä–µ—à–µ–Ω–∞, –Ω–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã **3 –Ω–æ–≤—ã–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**.

---

## ‚úÖ –†–µ—à—ë–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–ë—ã–ª–æ:**
- WebSocket –∑–∞–ø—É—Å–∫–∞–ª—Å—è –¥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ –≤ –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –§–ª–∞–≥ `_is_syncing` –±—ã–ª –∫–æ—Å—Ç—ã–ª—ë–º

**–°—Ç–∞–ª–æ:**
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –î–û –∑–∞–ø—É—Å–∫–∞ WebSocket
- WebSocket –æ–±–Ω–æ–≤–ª—è–µ—Ç —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

---

## ‚ùå –ù–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: Private WebSocket –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ

**–ö–æ–¥:**
```python
for symbol in symbols:
    restore_state_from_exchange()  # –ú–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é
    start Position WebSocket
# –ü–û–¢–û–ú:
start Private WebSocket  # ‚ùå –°–õ–ò–®–ö–û–ú –ü–û–ó–î–ù–û!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `restore_state_from_exchange()` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ REST API (limit order)
- –ü–æ–∑–∏—Ü–∏—è –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç—å—Å—è –ø–æ–∫–∞ Private WS –Ω–µ –∑–∞–ø—É—â–µ–Ω
- Execution event –±—É–¥–µ—Ç **–ø—Ä–æ–ø—É—â–µ–Ω**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ fill events –Ω–∞—Ä—É—à–µ–Ω–æ

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
T0: restore –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç LONG @ $100 (limit order)
T1: Limit order –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –±–∏—Ä–∂–µ
T2: Bybit sends execution event
T3: [Private WS –Ω–µ –∑–∞–ø—É—â–µ–Ω] ‚Üí event lost ‚ùå
T4: Private WS –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (—á–µ—Ä–µ–∑ 5-10 —Å–µ–∫)
T5: Execution event –ø–æ—Ç–µ—Ä—è–Ω –Ω–∞–≤—Å–µ–≥–¥–∞
```

**Impact:** 
- –°—Ä–µ–¥–Ω–∏–π - REST API –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –æ—Ä–¥–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- –ù–æ execution stream –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è fee tracking, fill prices
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è–º –≤ realized PnL

**Fix:** –ó–∞–ø—É—Å—Ç–∏—Ç—å Private WS **–î–û** restore –∏–ª–∏ **–º–µ–∂–¥—É** –ø–æ–ª—É—á–µ–Ω–∏–µ–º –ø–æ–∑–∏—Ü–∏–π –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –Ω–æ–≤—ã—Ö.

---

### 2. –û–∫–Ω–æ –º–µ–∂–¥—É restore –∏ Position WebSocket

**–ö–æ–¥:**
```python
restore_state_from_exchange()  # –°–æ–∑–¥–∞–µ—Ç TP @ $105
[–í–†–ï–ú–ï–ù–ù–û–ï –û–ö–ù–û 1-2 —Å–µ–∫]
start Position WebSocket       # –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ updates
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- restore —Å–æ–∑–¥–∞–µ—Ç TP –æ—Ä–¥–µ—Ä
- –¶–µ–Ω–∞ –º–æ–∂–µ—Ç —Ä–µ–∑–∫–æ –¥–≤–∏–Ω—É—Ç—å—Å—è
- TP –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è
- Position WS –µ—â–µ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
T0: restore —Å–æ–∑–¥–∞–µ—Ç TP @ $105
T1: [–û–ö–ù–û]
T2: –¶–µ–Ω–∞ —Å–∫–∞—á–µ—Ç –¥–æ $105 ‚Üí TP fills
T3: [Position WS –Ω–µ –∑–∞–ø—É—â–µ–Ω] ‚Üí event lost
T4: Position WS –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
T5: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
```

**Impact:**
- –ù–∏–∑–∫–∏–π - –æ—á–µ–Ω—å –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ —á—Ç–æ TP –∏—Å–ø–æ–ª–Ω–∏—Ç—Å—è –∑–∞ 1-2 —Å–µ–∫
- –ù–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π sync_with_exchange() –ø–æ–π–º–∞–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ

**Fix:** –ó–∞–ø—É—Å—Ç–∏—Ç—å Position WS **–ø–µ—Ä–µ–¥** —Å–æ–∑–¥–∞–Ω–∏–µ–º TP –æ—Ä–¥–µ—Ä–æ–≤.

---

### 3. Multi-symbol sequential restore (–∑–∞–¥–µ—Ä–∂–∫–∞)

**–ö–æ–¥:**
```python
for symbol in [SOLUSDT, DOGEUSDT, ETHUSDT]:
    restore_state_from_exchange()  # 5 —Å–µ–∫ –Ω–∞ —Å–∏–º–≤–æ–ª
    start Position WebSocket
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- DOGEUSDT –Ω–∞—á–Ω–µ—Ç —Ç–æ—Ä–≥–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ 10 —Å–µ–∫ –ø–æ—Å–ª–µ SOLUSDT
- ETHUSDT —á–µ—Ä–µ–∑ 15 —Å–µ–∫
- –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è

**Impact:**
- –ù–∏–∑–∫–∏–π - –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏–µ–º–ª–µ–º–∞
- –ù–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å

**Fix:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π restore –¥–ª—è –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤ (async/await).

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ñ–∏–∫—Å—ã

### Fix 1: –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ WebSocket'–æ–≤

**–í–∞—Ä–∏–∞–Ω—Ç A (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π):** –ó–∞–ø—É—Å—Ç–∏—Ç—å Private WS –ø–µ—Ä–≤—ã–º
```python
# –î–û –ª—é–±–æ–≥–æ restore:
start Private WebSocket  

for symbol in symbols:
    restore_state_from_exchange()
    start Position WebSocket
```

**–ü–ª—é—Å—ã:** Execution stream —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞  
**–ú–∏–Ω—É—Å—ã:** Private WS –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å execution events –¥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç B (–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π):** –†–∞–∑–¥–µ–ª–∏—Ç—å restore –Ω–∞ –¥–≤–µ —Ñ–∞–∑—ã
```python
# –§–∞–∑–∞ 1: –£–∑–Ω–∞—Ç—å —á—Ç–æ –µ—Å—Ç—å (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
for symbol in symbols:
    check_positions_from_exchange()  # –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
    restore_existing_positions()     # –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

# –§–∞–∑–∞ 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å WebSocket'—ã
start Private WebSocket
for symbol in symbols:
    start Position WebSocket

# –§–∞–∑–∞ 3: –û—Ç–∫—Ä—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
for symbol in symbols:
    if need_initial_position:
        open_initial_position()  # –¢–µ–ø–µ—Ä—å Private WS —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        create_tp_order()
```

**–ü–ª—é—Å—ã:** 
- Execution events –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
- –ß–∏—Å—Ç–∞—è –∏–∑–æ–ª—è—Ü–∏—è —Ñ–∞–∑
- WebSocket'—ã —Ä–∞–±–æ—Ç–∞—é—Ç –¥–æ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ú–∏–Ω—É—Å—ã:** 
- –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
- –ù—É–∂–Ω–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å restore_state_from_exchange()

---

### Fix 2: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ WebSocket

```python
for symbol in symbols:
    restore_state_from_exchange()
    start Position WebSocket
    
    # ‚≠ê –ù–û–í–û–ï: –ü–µ—Ä–µ-–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    verify_state_after_ws_start()  # Quick REST check
```

–≠—Ç–æ "defensive programming" - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ WS –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ.

---

### Fix 3: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π restore (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```python
import asyncio

async def restore_all_symbols():
    tasks = [
        restore_symbol_async(symbol)
        for symbol in symbols
    ]
    await asyncio.gather(*tasks)
```

–°–æ–∫—Ä–∞—Ç–∏—Ç –æ–±—â–µ–µ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ —Å `N * 5 —Å–µ–∫` –¥–æ `5 —Å–µ–∫`.

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** ‚ö†Ô∏è –°–†–ï–î–ù–Ø–Ø

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ–∏–∫—Å (—Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å):**
1. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–ø—É—Å–∫ Private WebSocket **–ø–µ—Ä–µ–¥** —Ü–∏–∫–ª–æ–º restore
2. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ

**–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–∏–∫—Å (—Å–¥–µ–ª–∞—Ç—å –ø–æ–∑–∂–µ):**
1. –†–∞–∑–¥–µ–ª–∏—Ç—å restore –Ω–∞ read-only –∏ write —Ñ–∞–∑—ã
2. –ó–∞–ø—É—Å–∫–∞—Ç—å WebSocket'—ã –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:**
- –ü—Ä–æ–±–ª–µ–º—ã –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π sync_with_exchange() –ø–æ–π–º–∞–µ—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π
- –ù–æ –ª—É—á—à–µ –∑–∞—Ñ–∏–∫—Å–∏—Ç—å –¥–ª—è production readiness

